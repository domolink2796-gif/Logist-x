<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOGIST_MASTER | HQ ELITE v20.5</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#010409">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1162/1162456.png">

    <!-- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: React, Babel, Tailwind, Lucide -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #010409; color: #e6edf3; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(20px); border: 1px solid #30363d; border-radius: 28px; }
        .btn-gold { background: linear-gradient(135deg, #f59e0b, #b45309); color: #000; font-weight: 900; transition: 0.2s; }
        .btn-gold:active { transform: scale(0.96); }
        .input-dark { background: #000; border: 1px solid #30363d; color: #fff; outline: none; transition: 0.3s; }
        .input-dark:focus { border-color: #f59e0b; }
        .modal-overlay { background: rgba(0,0,0,0.98); backdrop-filter: blur(15px); z-index: 1000; }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- –¢–í–û–ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ---
    const MY_MAIN_ID = "1FdKuk1uTmKUxikom1i-mTPdET0dQJAaAyn9ITd-huHI";
    const MY_MASTER_URL = "https://script.google.com/macros/s/AKfycbxzoUD69dgAiHRVPNc-4seydmFcR8L812GM9pU1gqnXA1eG_BQ-3gP3KkkyLbxNyfKpMg/exec";

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–∫–æ–Ω–æ–∫ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–º Lucide)
    const Icon = ({ name, size = 20, className = "" }) => {
        const iconRef = useRef(null);
        useEffect(() => {
            if (window.lucide && iconRef.current) {
                window.lucide.createIcons({
                    targets: [iconRef.current]
                });
            }
        }, [name]);
        return <i ref={iconRef} data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
    };

    const App = () => {
        const [projects, setProjects] = useState(() => {
            const saved = localStorage.getItem('master_projects_v20_5');
            return saved ? JSON.parse(saved) : [
                { name: "–ú–æ–π –†–µ–µ—Å—Ç—Ä", url: MY_MASTER_URL, techPass: "–ï–≤–≥–µ–Ω–∏–π –ù–∏–∫–∏—Ç–∏–Ω" }
            ];
        });

        const [activeIdx, setActiveIdx] = useState(0);
        const [isAuth, setIsAuth] = useState(false);
        const [passInput, setPassInput] = useState("");
        const [keys, setKeys] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showProjects, setShowProjects] = useState(false);
        const [showGen, setShowGen] = useState(false);
        const [confirmDelete, setConfirmDelete] = useState(null);
        const [renewDays, setRenewDays] = useState({});
        
        const [clientUrl, setClientUrl] = useState("");
        const [genPass, setGenPass] = useState("Elite" + Math.floor(Math.random()*900 + 100));
        const [genResult, setGenResult] = useState("");

        const cur = projects[activeIdx];

        useEffect(() => {
            localStorage.setItem('master_projects_v20_5', JSON.stringify(projects));
        }, [projects]);

        useEffect(() => {
            if (isAuth) sync();
        }, [isAuth, activeIdx]);

        const checkLogin = () => {
            if (passInput.trim().toLowerCase() === '–µ–≤–≥–µ–Ω–∏–π –Ω–∏–∫–∏—Ç–∏–Ω') setIsAuth(true);
            else alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!");
        };

        const sync = async () => {
            if (!cur?.url) return;
            setLoading(true);
            try {
                const res = await fetch(cur.url, { 
                    method: 'POST', 
                    body: JSON.stringify({action:'list_keys', adminPass: cur.techPass}) 
                });
                const data = await res.json();
                setKeys((data.keys || []).sort((a, b) => b.expiry - a.expiry));
            } catch(e) { 
                console.error(e); 
            } finally { setLoading(false); }
        };

        const handleAction = async (payload) => {
            setLoading(true);
            try {
                const res = await fetch(cur.url, {
                    method: 'POST',
                    body: JSON.stringify({ ...payload, adminPass: cur.techPass })
                });
                const r = await res.json();
                if (r.status === 'success') {
                    setConfirmDelete(null);
                    sync();
                }
            } finally { setLoading(false); }
        };

        const generateRobotCode = () => {
            let clientId = clientUrl;
            if(clientId.includes('/d/')) clientId = clientId.split('/d/')[1].split('/')[0];
            if(!clientId) return alert("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–∞–±–ª–∏—Ü—É");

            const code = `/**
 * LOGIST_X BRIDGE ROBOT v20.5
 * CLIENT_SS: ${clientId}
 * MASTER_NODE: ${MY_MASTER_URL}
 */

const CLIENT_SS_ID = "${clientId}";
const MASTER_URL = "${MY_MASTER_URL}";
const ADMIN_PASS = "${genPass}";

function doPost(e) {
  let data = JSON.parse(e.postData.contents);
  const action = data.action;

  if (["check_license", "add_key", "list_keys", "renew_key", "delete_key"].includes(action)) {
    data.ownerPass = "–ï–≤–≥–µ–Ω–∏–π –ù–∏–∫–∏—Ç–∏–Ω"; 
    const options = {
      method: "post", contentType: "application/json",
      payload: JSON.stringify(data), muteHttpExceptions: true
    };
    const response = UrlFetchApp.fetch(MASTER_URL, options);
    return ContentService.createTextOutput(response.getContentText()).setMimeType(ContentService.MimeType.JSON);
  }

  if (action === "save_report") {
    try {
      const folder = DriveApp.getFolderById(data.folderId);
      const cityFolder = getOrCreateFolder(folder, data.city);
      const dateStr = Utilities.formatDate(new Date(), "GMT+3", "dd.MM.yyyy");
      const dateFolder = getOrCreateFolder(cityFolder, dateStr);
      const clientFolder = getOrCreateFolder(dateFolder, data.client);
      
      const fileName = data.city + " " + data.address + ".jpg";
      const blob = Utilities.newBlob(Utilities.base64Decode(data.image), "image/jpeg", fileName);
      const fileUrl = clientFolder.createFile(blob).getUrl();
      
      const reportSS = SpreadsheetApp.openById(CLIENT_SS_ID);
      reportSS.getSheets()[0].appendRow([new Date(), data.client, data.address, data.workType, data.price, fileUrl, data.coords]);
      return response({ status: "success" });
    } catch (err) { return response({ status: "error", message: err.toString() }); }
  }
}

function getOrCreateFolder(p, n) {
  const f = p.getFoldersByName(n || "–û–±—â–∏–π");
  return f.hasNext() ? f.next() : p.createFolder(n || "–û–±—â–∏–π");
}

function response(o) {
  return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON);
}`;
            setGenResult(code);
        };

        if(!isAuth) {
            return (
                <div className="h-screen flex items-center justify-center p-6 bg-[#010409]">
                    <div className="bg-[#0d1117] p-10 w-full max-w-sm text-center rounded-[3rem] border border-white/5 shadow-2xl">
                        <Icon name="shield-check" size={48} className="text-amber-500 mx-auto mb-6" />
                        <h1 className="text-xl font-black mb-8 uppercase tracking-widest italic text-white leading-none">Logist Master</h1>
                        <input type="password" value={passInput} onChange={e=>setPassInput(e.target.value)} placeholder="Master Password" 
                               className="input-dark w-full p-4 rounded-2xl mb-4 text-center text-white font-bold" 
                               onKeyDown={e=>e.key==='Enter'&&checkLogin()} />
                        <button onClick={checkLogin} className="bg-amber-500 text-black w-full py-5 rounded-2xl font-black uppercase text-[10px] tracking-widest active:scale-95 transition-all">–í–æ–π—Ç–∏ –≤ –®—Ç–∞–±</button>
                    </div>
                </div>
            );
        }

        return (
            <div className="p-4 md:p-10 max-w-6xl mx-auto min-h-screen bg-[#010409] text-white text-left">
                <header className="flex justify-between items-center mb-10 bg-[#0d1117] p-6 rounded-[2.5rem] border border-white/5 shadow-xl relative overflow-hidden">
                    <div className="flex items-center gap-4 relative z-10">
                        <div className="w-12 h-12 bg-amber-500 rounded-2xl flex items-center justify-center text-black shadow-lg">
                            <Icon name="zap" size={24} className="fill-black" />
                        </div>
                        <div>
                            <h1 className="text-xl font-black italic text-amber-500 uppercase leading-none tracking-tighter">Master HQ</h1>
                            <div className="flex items-center gap-2 mt-1">
                                 <span className="text-[10px] opacity-40 font-bold uppercase tracking-[3px] truncate max-w-[120px]">{cur.name}</span>
                                 <div className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-2 relative z-10">
                        <button onClick={()=>setShowProjects(true)} className="p-4 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all"><Icon name="settings" /></button>
                        <button onClick={sync} className="p-4 bg-amber-500 text-black rounded-2xl shadow-lg active:scale-90 transition-all"><Icon name="refresh-cw" className={loading?'animate-spin':''} /></button>
                    </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                    <div className="lg:col-span-2 space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {keys.map(k => {
                                const diff = k.expiry - new Date().getTime();
                                const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
                                const isExpired = daysLeft <= 0;
                                const isUnassigned = !k.worker || k.worker.toLowerCase() === "–Ω–æ–≤—ã–π";

                                return (
                                    <div key={k.key} className={`bg-[#0d1117] p-6 rounded-[2.5rem] border transition-all ${isExpired ? 'border-red-500/20 bg-red-500/5' : isUnassigned ? 'border-blue-500/20' : 'border-white/5 hover:border-amber-500/30'} relative overflow-hidden group`}>
                                        
                                        {confirmDelete === k.key && (
                                            <div className="absolute inset-0 bg-red-600 z-50 flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
                                                <Icon name="alert-circle" size={32} className="mb-2 text-white" />
                                                <p className="text-[10px] font-black uppercase mb-4 text-white">–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ—Å—Ç—É–ø?</p>
                                                <div className="flex gap-2 w-full">
                                                    <button onClick={() => handleAction({action:'delete_key', licenseKey: k.key})} className="flex-1 bg-white text-red-600 py-3 rounded-xl font-black text-[10px] uppercase">–£–¥–∞–ª–∏—Ç—å</button>
                                                    <button onClick={() => setConfirmDelete(null)} className="flex-1 bg-black/20 text-white py-3 rounded-xl font-black text-[10px] uppercase">–û—Ç–º–µ–Ω–∞</button>
                                                </div>
                                            </div>
                                        )}

                                        <div className="flex justify-between items-start mb-6">
                                            <div className="text-amber-500 font-mono font-black text-sm tracking-widest">{k.key}</div>
                                            <div className="flex items-center gap-3">
                                                <div className={`text-[10px] font-black uppercase ${isExpired ? 'text-red-500' : 'text-emerald-500'}`}>
                                                    {isExpired ? '–ò—Å—Ç–µ–∫' : `${daysLeft} –¥–Ω.`}
                                                </div>
                                                <button onClick={() => setConfirmDelete(k.key)} className="text-white/10 hover:text-red-500 transition-all"><Icon name="trash-2" size={16} /></button>
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-2 mb-1 text-xl font-black uppercase truncate leading-none">
                                            <span className={isUnassigned ? "text-blue-400" : "text-white"}>{k.worker || "–û–∂–∏–¥–∞–µ—Ç –≤–æ—Ä–∫–µ—Ä–∞"}</span>
                                        </div>
                                        <div className="text-[10px] opacity-40 uppercase font-bold italic mb-8 tracking-widest truncate">{k.name}</div>
                                        
                                        <div className="flex gap-2 mb-4 bg-black/40 p-2 rounded-2xl border border-white/5">
                                            <input type="number" placeholder="+–î–Ω–∏" value={renewDays[k.key] || ''} onChange={(e)=>setRenewDays({...renewDays, [k.key]: e.target.value})}
                                                   className="bg-transparent w-full px-3 text-xs font-bold text-amber-500 outline-none" />
                                            <button onClick={() => handleAction({action:'renew_key', licenseKey: k.key, days: parseInt(renewDays[k.key])})} className="p-3 bg-white/5 rounded-xl text-amber-500"><Icon name="plus-circle" size={18} /></button>
                                        </div>

                                        <div className="flex gap-2">
                                            <button onClick={() => {
                                                const msg = `üöÄ LOGIST_X ACCESS\nüîë –ö–æ–¥: ${k.key}\nüåê –®—Ç–∞–±: ${cur.url}\nüì± App: https://${window.location.hostname}/app/\n\n*–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.`;
                                                navigator.clipboard.writeText(msg);
                                                alert("–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                                            }} className="flex-1 py-4 bg-amber-500 text-black rounded-2xl text-[10px] font-black uppercase flex items-center justify-center gap-2 active:scale-95 transition-all">
                                                <Icon name="copy" size={14}/> –î–æ—Å—Ç—É–ø
                                            </button>
                                            <a href={`https://drive.google.com/drive/folders/${k.folder}`} target="_blank" className="p-4 bg-white/5 rounded-2xl border border-white/10 text-white/40 hover:text-amber-500 transition-all">
                                                <Icon name="folder-open" size={16} />
                                            </a>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="space-y-6">
                        <div className="bg-[#0d1117] p-10 rounded-[3rem] space-y-6 border border-white/5 shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-amber-500"></div>
                            <div className="text-center mb-6">
                                 <h2 className="font-black uppercase text-[11px] tracking-[4px] italic text-amber-500 mb-1">–°–æ–∑–¥–∞—Ç—å –õ–∏—Ü–µ–Ω–∑–∏—é</h2>
                                 <p className="text-[8px] opacity-30 font-bold uppercase tracking-widest">–û–±—ä–µ–∫—Ç: {cur.name}</p>
                            </div>
                            <form onSubmit={(e)=>{e.preventDefault(); const fd=new FormData(e.target); handleAction({action:'add_key', workerName: fd.get('w'), clientName: fd.get('o'), days: fd.get('d')}); e.target.reset();}} className="space-y-4">
                                <input name="w" placeholder="–§–ò–û (–∏–ª–∏ –ø—É—Å—Ç–æ)" className="input-dark w-full p-4 rounded-xl font-bold" />
                                <input name="o" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –û–±—ä–µ–∫—Ç–∞" required className="input-dark w-full p-4 rounded-xl font-bold" />
                                <input name="d" type="number" defaultValue="30" className="input-dark w-full p-4 rounded-xl font-bold" />
                                <button className="w-full bg-amber-500 text-black py-5 rounded-2xl uppercase text-[11px] font-black tracking-widest shadow-xl active:scale-95 transition-all mt-4">–í—ã–ø—É—Å—Ç–∏—Ç—å –ö–ª—é—á</button>
                            </form>
                        </div>
                        
                        <button onClick={()=>setShowGen(true)} className="w-full bg-blue-600/10 border border-blue-500/20 p-5 rounded-3xl text-[10px] font-black uppercase tracking-widest text-blue-400 flex items-center justify-center gap-3 hover:bg-blue-600/20">
                            <Icon name="cpu" /> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Bridge v20.5
                        </button>
                    </div>
                </div>

                {/* MODALS (Projects & Generator) */}
                {showGen && (
                    <div className="fixed inset-0 modal-overlay flex items-center justify-center p-6 z-[2000]">
                        <div className="bg-[#0d1117] w-full max-w-2xl p-10 rounded-[4rem] border border-white/10 flex flex-col max-h-[90vh]">
                            <h3 className="font-black uppercase mb-8 text-blue-400 italic text-xl leading-none text-center">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ù–æ–≤–æ–≥–æ –ö–ª–∏–µ–Ω—Ç–∞</h3>
                            <div className="space-y-6 mb-8">
                                <div>
                                    <label className="text-[10px] uppercase opacity-40 font-black mb-3 block tracking-widest">1. –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –ö–õ–ò–ï–ù–¢–ê:</label>
                                    <input value={clientUrl} onChange={e=>setClientUrl(e.target.value)} placeholder="https://..." className="input-dark w-full p-4 rounded-2xl text-xs" />
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase opacity-40 font-black mb-3 block tracking-widest">2. –ü–∞—Ä–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ —à—Ç–∞–±–∞:</label>
                                    <input value={genPass} onChange={e=>setGenPass(e.target.value)} className="input-dark w-full p-4 rounded-2xl text-xs" />
                                </div>
                                <button onClick={generateRobotCode} className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-[11px] uppercase tracking-widest shadow-xl active:scale-95">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ú–æ—Å—Ç</button>
                            </div>
                            {genResult && (
                                <div className="flex-1 flex flex-col min-h-0 bg-black/50 rounded-[2rem] border border-white/5 p-6">
                                    <textarea readOnly value={genResult} className="flex-1 bg-transparent text-emerald-400 font-mono text-[10px] resize-none mb-4 outline-none" />
                                    <button onClick={() => {navigator.clipboard.writeText(genResult); alert("–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");}} className="bg-white text-black py-4 rounded-xl font-black text-[10px] uppercase flex items-center justify-center gap-2">
                                        <Icon name="copy" size={14} /> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç
                                    </button>
                                </div>
                            )}
                            <button onClick={()=>setShowGen(false)} className="mt-8 text-[11px] font-black uppercase opacity-20 hover:opacity-100 transition-all tracking-[4px] text-center">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                )}

                {showProjects && (
                    <div className="fixed inset-0 modal-overlay flex items-center justify-center p-6 z-[2000]">
                        <div className="bg-[#0d1117] w-full max-w-md p-10 rounded-[3rem] border border-white/10 shadow-2xl">
                            <h3 className="font-black uppercase mb-8 text-amber-500 italic text-xl text-center">–°–ø–∏—Å–æ–∫ –û–±—ä–µ–∫—Ç–æ–≤</h3>
                            <div className="space-y-3 mb-8 max-h-48 overflow-y-auto pr-2">
                                {projects.map((p, i) => (
                                    <div key={i} className={`p-5 rounded-2xl border flex justify-between items-center transition-all ${i===activeIdx?'border-amber-500 bg-amber-500/10':'border-white/5 bg-black'}`}>
                                        <div onClick={()=>{setActiveIdx(i); setShowProjects(false)}} className="cursor-pointer flex-1">
                                            <div className="font-black text-sm uppercase leading-none mb-1">{p.name}</div>
                                            <div className="text-[8px] opacity-20 truncate">{p.url}</div>
                                        </div>
                                        <button onClick={()=>{if(projects.length>1)setProjects(projects.filter((_,idx)=>idx!==i))}} className="text-red-500/40 hover:text-red-500 p-2"><Icon name="trash-2" size={18} /></button>
                                    </div>
                                ))}
                            </div>
                            <form onSubmit={e=>{e.preventDefault(); const fd=new FormData(e.target); setProjects([...projects, {name:fd.get('n'), url:fd.get('u'), techPass:fd.get('p')}]); e.target.reset();}} className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <input name="n" placeholder="–ò–º—è —à—Ç–∞–±–∞" required className="input-dark w-full p-4 rounded-xl text-xs font-bold" />
                                    <input name="p" placeholder="–¢–µ—Ö. –ø–∞—Ä–æ–ª—å" required className="input-dark w-full p-4 rounded-xl text-xs font-bold" />
                                </div>
                                <input name="u" placeholder="–°—Å—ã–ª–∫–∞ /exec" required className="input-dark w-full p-4 rounded-xl text-[10px]" />
                                <button className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-[11px] uppercase tracking-widest active:scale-95">–î–æ–±–∞–≤–∏—Ç—å –û–±—ä–µ–∫—Ç</button>
                            </form>
                            <button onClick={()=>setShowProjects(false)} className="mt-8 text-[11px] font-black uppercase opacity-20 hover:opacity-100 transition-all tracking-[4px] w-full text-center">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>

