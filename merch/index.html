<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MERCH X | PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* --- –°–¢–ò–õ–ò (–¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê) --- */
        :root { --bg: #000000; --card: #111111; --accent: #f59e0b; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        
        /* –®–∞–ø–∫–∞ */
        .header { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); padding: 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 10px; }
        .logo span { color: var(--accent); }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; }
        .s-v { display: block; font-size: 1.2rem; font-weight: 800; color: #fff; }
        .s-t { font-size: 0.6rem; text-transform: uppercase; opacity: 0.5; font-weight: 700; margin-top: 4px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ –∏–Ω–ø—É—Ç—ã */
        .btn-blue { background: var(--blue); color: white; padding: 14px; border-radius: 12px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 8px; font-size: 14px; }
        .btn-gold { background: var(--accent); color: #000; }
        input { width: 100%; padding: 14px; background: #1a1a1a; border: 1px solid var(--border); color: white; border-radius: 12px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }

        /* –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ */
        #srch { margin-bottom: 10px; }
        .card { background: var(--card); border: 1px solid var(--border); margin-bottom: 10px; padding: 15px; border-radius: 16px; position: relative; transition: 0.2s; }
        .card:active { transform: scale(0.98); background: #1a1a1a; }
        .card-net { font-size: 0.7rem; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .card-addr { font-size: 0.95rem; font-weight: 600; line-height: 1.3; }
        .dot { position: absolute; right: 15px; top: 15px; width: 8px; height: 8px; border-radius: 50%; background: #333; }
        .dot.done { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .dot.active { background: var(--blue); }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–¥–∞—á–∏ */
        .modal { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; overflow-y: auto; }
        .m-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #000; z-index: 10; }
        .m-body { padding: 20px; padding-bottom: 100px; }
        .f-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; margin-bottom: 5px; }
        
        /* –°–µ—Ç–∫–∞ —Ñ–æ—Ç–æ */
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .cam-btn { background: #1a1a1a; border: 1px dashed #444; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; color: #666; font-size: 0.6rem; font-weight: 700; }
        .cam-btn.ok { border: 1px solid var(--green); color: var(--green); background: rgba(0,255,0,0.1); }
        
        /* –ü–ª–∞–Ω–æ–≥—Ä–∞–º–º–∞ */
        .plan-box { padding: 15px; border: 1px dashed var(--accent); border-radius: 14px; background: rgba(245, 158, 11, 0.05); text-align: center; margin-bottom: 20px; }

        /* –°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ */
        .scan-overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .scan-view { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-ui { padding: 20px; background: #111; border-top: 1px solid var(--border); text-align: center; }
        .scan-frame { position: absolute; width: 70%; aspect-ratio: 1; border: 2px solid var(--accent); box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); border-radius: 20px; z-index: 10; pointer-events: none; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—á–µ—Ä–µ–¥–∏ */
        #syncIndicator { position: fixed; bottom: 20px; right: 20px; background: var(--red); color: #fff; padding: 10px 20px; border-radius: 30px; font-weight: 900; font-size: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; z-index: 500; }
        
        /* PDF –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä (—Å–∫—Ä—ã—Ç—ã–π) */
        #pdf-render { position: absolute; left: -9999px; width: 800px; background: #fff; color: #000; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="logo" style="font-size:2rem; margin-bottom:30px;">MERCH <span>X</span></div>
    <input type="text" id="lic-key" placeholder="–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –ö–ª—é—á" style="text-align:center;">
    <input type="text" id="work-name" placeholder="–í–∞—à–µ –ò–º—è (–§–∞–º–∏–ª–∏—è)" style="text-align:center;">
    <button class="btn-blue btn-gold" onclick="auth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
    <div style="font-size:10px; opacity:0.3; margin-top:20px;">v 2.0.1 | Server Connected</div>
</div>

<div id="scan-overlay" class="scan-overlay">
    <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; background:#000;">
        <div style="font-weight:900; font-size:18px;">SCANNER</div>
        <div onclick="closeScanner()" style="font-size:24px;">‚úï</div>
    </div>
    <div class="scan-view">
        <div id="reader"></div>
        <div class="scan-frame"></div>
    </div>
    <div class="scan-ui">
        <div id="scan-msg" style="color:var(--accent); font-weight:800; font-size:14px; margin-bottom:10px;">–ù–ê–í–ï–î–ò–¢–ï –ö–ê–ú–ï–†–£ –ù–ê –ö–û–î</div>
        <div id="new-prod-block" style="display:none;">
            <div style="color:#fff; margin-bottom:10px; font-size:12px;">–¢–û–í–ê–† –ù–ï –ù–ê–ô–î–ï–ù. –í–í–ï–î–ò–¢–ï –ù–ê–ó–í–ê–ù–ò–ï:</div>
            <input type="text" id="new-prod-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Coca-Cola 0.5">
            <button class="btn-blue btn-gold" onclick="saveNewProduct()">–°–û–•–†–ê–ù–ò–¢–¨ –ò –î–û–ë–ê–í–ò–¢–¨</button>
        </div>
        <button id="scan-close-btn" class="btn-blue" style="background:#333; margin-top:10px;" onclick="closeScanner()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="logo">LOGIST <span>X</span></div>
        <div style="font-size:10px; font-weight:700; color:#666;" id="app-ver">MERCH PRO</div>
    </div>
    <div class="stats-main">
        <div class="s-box"><span class="s-v" id="st-total">0</span><span class="s-t">–í—Å–µ–≥–æ –¢–æ—á–µ–∫</span></div>
        <div class="s-box"><span class="s-v" id="st-done" style="color:var(--green)">0</span><span class="s-t">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span></div>
    </div>
    <div style="display:flex; gap:10px;">
        <label class="btn-blue" style="flex:1; margin:0;" for="file-in">üìÇ –ó–ê–ì–†–£–ó–ò–¢–¨ XLSX</label>
        <button class="btn-blue" style="flex:0.3; background:var(--red); margin:0;" onclick="clearAll()">üóëÔ∏è</button>
    </div>
    <input type="file" id="file-in" hidden onchange="loadFile(this)">
    <input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞..." style="margin-top:15px; margin-bottom:0;" oninput="renderList()">
</div>

<div id="list" style="padding:15px;"></div>
<div id="syncIndicator" onclick="sync()">–û–¢–ü–†–ê–í–ö–ê: <span id="qCount">0</span></div>

<div id="task-modal" class="modal">
    <div class="m-head">
        <div>
            <div id="m-net" style="color:var(--accent); font-weight:900; font-size:14px; text-transform:uppercase;"></div>
            <div id="m-addr" style="font-size:12px; opacity:0.7;"></div>
        </div>
        <button style="background:none; border:none; color:#fff; font-size:24px;" onclick="closeModal()">‚úï</button>
    </div>
    <div class="m-body">
        
        <div id="start-block">
            <div class="plan-box" id="plan-check">
                <div style="opacity:0.6; font-size:12px;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã...</div>
            </div>
            <button class="btn-blue btn-green" style="background:var(--green); color:#000; height:60px; font-size:18px;" onclick="startVisit()">–ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
        </div>

        <div id="work-block" style="display:none;">
            
            <div style="background:#1a1a1a; padding:15px; border-radius:16px; margin-bottom:15px; border:1px solid #333;">
                <div style="font-size:12px; font-weight:800; color:var(--accent); margin-bottom:10px; text-transform:uppercase;">–°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –ò –û–°–¢–ê–¢–ö–ò</div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <span class="f-label">–ü–û–õ–ö–ê (–®–¢)</span>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="stock-shelf" value="0" style="text-align:center; font-weight:bold; font-size:18px;" oninput="calcTotal()">
                            <button onclick="openScanner('shelf')" style="width:50px; background:var(--accent); border:none; border-radius:12px; font-size:20px;">üì∑</button>
                        </div>
                    </div>
                    <div>
                        <span class="f-label">–°–ö–õ–ê–î (–®–¢)</span>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="stock-wh" value="0" style="text-align:center; font-weight:bold; font-size:18px;" oninput="calcTotal()">
                            <button onclick="openScanner('wh')" style="width:50px; background:var(--blue); border:none; border-radius:12px; font-size:20px; color:#fff;">üì∑</button>
                        </div>
                    </div>
                </div>
                
                <div style="text-align:center; margin-top:10px; padding-top:10px; border-top:1px solid #333;">
                    <span style="font-size:10px; opacity:0.5;">–û–ë–©–ò–ô –û–°–¢–ê–¢–û–ö</span>
                    <div id="total-stock" style="font-size:24px; font-weight:900; color:#fff;">0</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–ù–ê–® –§–ï–ô–°–ò–ù–ì</span><input type="number" id="faces-mine" value="0" oninput="calcShare()"></div>
                <div><span class="f-label">–í–°–ï–ì–û –ù–ê –ü–û–õ–ö–ï</span><input type="number" id="faces-total" value="0" oninput="calcShare()"></div>
            </div>
            <div style="text-align:center; margin-bottom:15px;">
                <span class="f-label">–î–û–õ–Ø –ü–û–õ–ö–ò</span>
                <div style="font-size:18px; font-weight:900; color:var(--accent);"><span id="share-val">0</span>%</div>
            </div>

            <span class="f-label">–¶–ï–ù–´ (–†–£–ë)</span>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input type="number" id="price-our" placeholder="–ù–∞—à–∞" step="0.1">
                <input type="number" id="price-comp" placeholder="–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç" step="0.1">
            </div>
            <span class="f-label">–°–†–û–ö –ì–û–î–ù–û–°–¢–ò</span>
            <input type="date" id="exp-date">

            <span class="f-label" style="margin-top:20px;">–§–û–¢–û–û–¢–ß–ï–¢ (3 —Ñ–æ—Ç–æ)</span>
            <div class="photo-grid">
                <label class="cam-btn" id="l-p1">üì∏ –î–û<input type="file" hidden accept="image/*" capture="camera" onchange="procImg(this, 'pre')"></label>
                <label class="cam-btn" id="l-p2">üì∏ –ü–û–°–õ–ï<input type="file" hidden accept="image/*" capture="camera" onchange="procImg(this, 'post')"></label>
                <label class="cam-btn" id="l-p3">üì∏ –¶–ï–ù–ù–ò–ö<input type="file" hidden accept="image/*" capture="camera" onchange="procImg(this, 'price')"></label>
            </div>

            <button class="btn-blue btn-green" id="fin-btn" style="margin-top:30px; background:var(--green); color:#000;" onclick="finishVisit()">–ó–ê–í–ï–†–®–ò–¢–¨ –í–ò–ó–ò–¢</button>
        </div>

        <div id="arch-block" style="display:none; text-align:center;">
            <div style="font-size:18px; font-weight:900; color:var(--green); margin-bottom:10px;">–í–ò–ó–ò–¢ –ó–ê–í–ï–†–®–ï–ù</div>
            <div id="arch-info" style="opacity:0.7; font-size:12px; line-height:1.6; margin-bottom:20px;"></div>
            <button class="btn-blue" onclick="resetVisit()">üîÑ –ü–ï–†–ï–î–ï–õ–ê–¢–¨ –û–¢–ß–ï–¢</button>
        </div>

    </div>
</div>

<div id="pdf-render">
    <div style="padding:40px; box-sizing:border-box; border:1px solid #000;">
        <div style="display:flex; justify-content:space-between; border-bottom:4px solid #000; padding-bottom:15px;">
            <div style="font-size:36px; font-weight:900;">MERCH <span style="color:#f59e0b">X</span></div>
            <div id="pdf-date" style="font-size:16px; margin-top:15px; opacity:0.6;"></div>
        </div>
        <div style="margin-top:30px;">
            <div id="pdf-net" style="color:#f59e0b; font-weight:800; font-size:18px; text-transform:uppercase;"></div>
            <div id="pdf-addr" style="font-size:32px; font-weight:900; margin-bottom:10px;"></div>
            <div style="font-size:18px; margin-top:10px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫: <b id="pdf-worker"></b></div>
            <div style="background:#eee; padding:15px; margin-top:20px; border-radius:10px; font-weight:800;">
                –í–†–ï–ú–Ø –í –ú–ê–ì–ê–ó–ò–ù–ï: <span id="pdf-dur"></span> (<span id="pdf-time"></span>)
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-top:40px;">
            <div style="background:#f9f9f9; padding:20px; border-radius:20px;">
                <div style="font-size:12px; font-weight:800; opacity:0.5;">–û–°–¢–ê–¢–ö–ò</div>
                <div style="font-size:48px; font-weight:900;"><span id="pdf-stock">0</span> <span style="font-size:16px; opacity:0.5;">—à—Ç</span></div>
                <div style="font-size:14px; margin-top:5px;">–ü–æ–ª–∫–∞: <b id="pdf-s-shelf"></b> / –°–∫–ª–∞–¥: <b id="pdf-s-wh"></b></div>
            </div>
            <div style="background:#f9f9f9; padding:20px; border-radius:20px;">
                <div style="font-size:12px; font-weight:800; opacity:0.5;">–î–û–õ–Ø –ü–û–õ–ö–ò</div>
                <div style="font-size:48px; font-weight:900; color:#f59e0b;"><span id="pdf-share">0</span>%</div>
                <div style="font-size:14px; margin-top:5px;">–§–µ–π—Å–∏–Ω–≥: <b id="pdf-faces"></b></div>
            </div>
        </div>
        <div style="margin-top:30px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div>–¶–µ–Ω—ã (–ú—ã/–ö–æ–Ω–∫): <b id="pdf-prices"></b></div>
            <div>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏: <b id="pdf-exp"></b></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:40px;">
            <img id="pdf-img1" style="width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:10px;">
            <img id="pdf-img2" style="width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:10px;">
            <img id="pdf-img3" style="width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:10px;">
        </div>
    </div>
</div>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    const API_URL = 'https://logist-x-server-production.up.railway.app'; // –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∞–¥—Ä–µ—Å –≤–µ—Ä–µ–Ω
    
    let DATA = { shops: [], user: "", key: "" };
    let CUR = null; // –¢–µ–∫—É—â–∏–π –º–∞–≥–∞–∑–∏–Ω
    let IMGS = { pre:null, post:null, price:null };
    let db;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–∫–∞–Ω–µ—Ä–∞
    let html5QrCode;
    let scanTarget = 'shelf'; // 'shelf' –∏–ª–∏ 'wh'
    let lastCode = null;

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    window.onload = () => {
        DATA.user = localStorage.getItem('mx_user');
        DATA.key = localStorage.getItem('mx_key');
        DATA.shops = JSON.parse(localStorage.getItem('mx_shops') || "[]");
        
        if(!DATA.user || !DATA.key) document.getElementById('auth-screen').style.display = 'flex';
        else {
            document.getElementById('auth-screen').style.display = 'none';
            checkLic(); // –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏
        }
        
        initDB();
        renderList();
    };

    async function auth() {
        const k = document.getElementById('lic-key').value.trim().toUpperCase();
        const n = document.getElementById('work-name').value.trim();
        if(!k || !n) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
        
        try {
            const r = await fetch(API_URL + '/check-license', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ licenseKey: k, workerName: n })
            });
            const d = await r.json();
            if(d.status === 'active') {
                localStorage.setItem('mx_user', n);
                localStorage.setItem('mx_key', k);
                DATA.user = n; DATA.key = k;
                document.getElementById('auth-screen').style.display = 'none';
                alert(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${n}!`);
            } else alert(d.message);
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
    }
    
    async function checkLic() {
        // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å UI –µ—Å–ª–∏ –∏—Å—Ç–µ–∫
        try {
            await fetch(API_URL + '/check-license', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ licenseKey: DATA.key, workerName: DATA.user })
            });
        } catch(e){}
    }

    // --- –°–ü–ò–°–û–ö –ú–ê–ì–ê–ó–ò–ù–û–í ---
    function loadFile(inp) {
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            DATA.shops = rows.map((x, i) => ({
                id: i,
                net: x['–°–µ—Ç—å'] || '–ú–∞–≥–∞–∑–∏–Ω',
                addr: x['–ê–¥—Ä–µ—Å'] || '–ë–µ–∑ –∞–¥—Ä–µ—Å–∞',
                city: x['–ì–æ—Ä–æ–¥'] || '–ì–æ—Ä–æ–¥',
                lat: x['–®–∏—Ä–æ—Ç–∞'], lon: x['–î–æ–ª–≥–æ—Ç–∞'],
                done: false, data: null
            }));
            localStorage.setItem('mx_shops', JSON.stringify(DATA.shops));
            renderList();
        };
        r.readAsArrayBuffer(inp.files[0]);
    }

    function renderList() {
        const s = document.getElementById('srch').value.toLowerCase();
        const l = document.getElementById('list');
        let doneC = 0;
        l.innerHTML = DATA.shops.filter(x => (x.addr.toLowerCase().includes(s) || x.net.toLowerCase().includes(s))).map(x => {
            if(x.done) doneC++;
            return `<div class="card" onclick="openTask(${x.id})">
                <div class="dot ${x.done ? 'done' : (x.start ? 'active' : '')}"></div>
                <div class="card-net">${x.net}</div>
                <div class="card-addr">${x.addr}</div>
            </div>`;
        }).join('');
        document.getElementById('st-total').innerText = DATA.shops.length;
        document.getElementById('st-done').innerText = doneC;
    }

    function clearAll() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–π—Ç–∏?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- –õ–û–ì–ò–ö–ê –í–ò–ó–ò–¢–ê ---
    function openTask(id) {
        CUR = DATA.shops.find(x => x.id === id);
        document.getElementById('m-net').innerText = CUR.net;
        document.getElementById('m-addr').innerText = CUR.addr;
        document.getElementById('task-modal').style.display = 'flex';
        
        document.getElementById('start-block').style.display = 'none';
        document.getElementById('work-block').style.display = 'none';
        document.getElementById('arch-block').style.display = 'none';

        if(CUR.done) {
            document.getElementById('arch-block').style.display = 'block';
            document.getElementById('arch-info').innerHTML = `
                –î–∞—Ç–∞: ${CUR.data.date}<br>
                –í—Ä–µ–º—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ: ${CUR.data.duration}<br>
                –û—Å—Ç–∞—Ç–æ–∫: ${parseInt(CUR.data.s_shelf)+parseInt(CUR.data.s_wh)} —à—Ç
            `;
        } else if(CUR.start) {
            restoreForm();
            document.getElementById('work-block').style.display = 'block';
        } else {
            document.getElementById('start-block').style.display = 'block';
            checkPlan();
        }
    }
    
    function closeModal() {
        document.getElementById('task-modal').style.display = 'none';
        if(html5QrCode) closeScanner();
    }

    async function checkPlan() {
        const box = document.getElementById('plan-check');
        box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã...';
        try {
            const r = await fetch(`${API_URL}/get-planogram?key=${DATA.key}&addr=${encodeURIComponent(CUR.addr)}`);
            const d = await r.json();
            if(d.exists) {
                box.innerHTML = `<div style="color:var(--green); font-weight:800; margin-bottom:5px;">‚úÖ –ï–°–¢–¨ –°–•–ï–ú–ê</div>
                <button class="btn-blue" style="font-size:12px; padding:8px;" onclick="window.open('${d.url}')">–û–¢–ö–†–´–¢–¨ –°–•–ï–ú–£</button>
                <label style="font-size:10px; display:block; margin-top:10px; text-decoration:underline;">–û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ<input type="file" hidden accept="image/*" onchange="upPlan(this)"></label>`;
            } else {
                box.innerHTML = `<div style="font-size:12px; margin-bottom:5px;">–ü–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã –Ω–µ—Ç</div>
                <label class="btn-blue" style="font-size:12px; background:#333;">üì∏ –ó–ê–ì–†–£–ó–ò–¢–¨ –°–•–ï–ú–£<input type="file" hidden accept="image/*" onchange="upPlan(this)"></label>`;
            }
        } catch(e) { box.innerHTML = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"; }
    }

    async function upPlan(inp) {
        if(!inp.files[0]) return;
        const img = await compress(inp.files[0]);
        await fetch(`${API_URL}/upload-planogram`, {
            method: 'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ key:DATA.key, addr:CUR.addr, image:img })
        });
        checkPlan();
    }

    function startVisit() {
        CUR.start = Date.now();
        localStorage.setItem('mx_shops', JSON.stringify(DATA.shops));
        document.getElementById('start-block').style.display = 'none';
        document.getElementById('work-block').style.display = 'block';
        // –û–±–Ω—É–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
        document.getElementById('stock-shelf').value = 0;
        document.getElementById('stock-wh').value = 0;
        document.getElementById('faces-mine').value = 0;
        document.getElementById('faces-total').value = 0;
        IMGS = { pre:null, post:null, price:null };
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('ok'));
        calcTotal();
    }

    function resetVisit() {
        if(confirm("–î–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
            CUR.done = false; CUR.start = null; CUR.data = null;
            openTask(CUR.id);
        }
    }

    // --- –°–ö–ê–ù–ï–† –ò –¢–û–í–ê–†–´ ---
    function openScanner(type) {
        scanTarget = type;
        document.getElementById('scan-overlay').style.display = 'flex';
        document.getElementById('new-prod-block').style.display = 'none';
        document.getElementById('scan-msg').style.display = 'block';
        
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan, (err)=>{});
    }

    function closeScanner() {
        if(html5QrCode) html5QrCode.stop().then(()=> html5QrCode.clear());
        document.getElementById('scan-overlay').style.display = 'none';
    }

    async function onScan(code) {
        if(lastCode === code) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—Ä–µ–±–µ–∑–≥–∞
        lastCode = code;
        
        // –ó–≤—É–∫ –ø–∏–∫–∞
        speak("–ü–∏–∫");

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ
        try {
            const r = await fetch(`${API_URL}/check-barcode?code=${code}&key=${DATA.key}`);
            const d = await r.json();
            
            if(d.exists) {
                // –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω -> –î–æ–±–∞–≤–ª—è–µ–º
                addStock(scanTarget);
                document.getElementById('scan-msg').innerHTML = `<span style="color:var(--green)">${d.name}</span><br>+1 –î–û–ë–ê–í–õ–ï–ù–û`;
                setTimeout(() => { lastCode = null; document.getElementById('scan-msg').innerText = "–°–ö–ê–ù–ò–†–£–ô–¢–ï –î–ê–õ–¨–®–ï..."; }, 1500);
            } else {
                // –¢–æ–≤–∞—Ä –Ω–æ–≤—ã–π -> –ü–∞—É–∑–∞ –∏ –≤–≤–æ–¥ –∏–º–µ–Ω–∏
                html5QrCode.pause();
                document.getElementById('scan-msg').style.display = 'none';
                document.getElementById('new-prod-block').style.display = 'block';
                document.getElementById('new-prod-name').focus();
            }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
    }

    function addStock(target) {
        const el = document.getElementById(target === 'shelf' ? 'stock-shelf' : 'stock-wh');
        el.value = parseInt(el.value) + 1;
        calcTotal();
    }

    async function saveNewProduct() {
        const name = document.getElementById('new-prod-name').value;
        if(!name) return;
        
        try {
            await fetch(`${API_URL}/save-barcode`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ key: DATA.key, code: lastCode, name: name })
            });
            // –£—Å–ø–µ—Ö
            addStock(scanTarget);
            document.getElementById('new-prod-block').style.display = 'none';
            document.getElementById('new-prod-name').value = "";
            document.getElementById('scan-msg').style.display = 'block';
            document.getElementById('scan-msg').innerText = "–°–û–•–†–ê–ù–ï–ù–û! –ì–û–¢–û–í –ö –°–õ–ï–î–£–Æ–©–ï–ú–£...";
            html5QrCode.resume();
            lastCode = null;
        } catch(e) { alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å"); }
    }

    function speak(txt) {
        if(window.speechSynthesis) {
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'ru-RU'; u.rate = 1.5;
            window.speechSynthesis.speak(u);
        }
    }

    function calcTotal() {
        const s = parseInt(document.getElementById('stock-shelf').value) || 0;
        const w = parseInt(document.getElementById('stock-wh').value) || 0;
        document.getElementById('total-stock').innerText = s + w;
    }
    
    function calcShare() {
        const m = document.getElementById('faces-mine').value;
        const t = document.getElementById('faces-total').value;
        document.getElementById('share-val').innerText = (t > 0) ? Math.round((m/t)*100) : 0;
    }

    // --- –§–û–¢–û –ò –û–¢–ü–†–ê–í–ö–ê ---
    async function procImg(inp, type) {
        if(inp.files[0]) {
            IMGS[type] = await compress(inp.files[0]);
            document.getElementById(type === 'pre' ? 'l-p1' : (type === 'post' ? 'l-p2' : 'l-p3')).classList.add('ok');
        }
    }

    function compress(file) {
        return new Promise(res => {
            const r = new FileReader();
            r.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d');
                    let w = img.width, h = img.height;
                    const max = 1000;
                    if(w > h) { if(w > max) { h*=max/w; w=max; } } else { if(h > max) { w*=max/h; h=max; } }
                    c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
                    res(c.toDataURL('image/jpeg', 0.6));
                }
            }; r.readAsDataURL(file);
        });
    }

    async function finishVisit() {
        if(!IMGS.pre || !IMGS.post || !IMGS.price) return alert("–°–¥–µ–ª–∞–π—Ç–µ 3 —Ñ–æ—Ç–æ!");
        const btn = document.getElementById('fin-btn');
        btn.disabled = true; btn.innerText = "–ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê...";

        // –î–∞–Ω–Ω—ã–µ
        const now = new Date();
        const startT = new Date(CUR.start);
        const dur = Math.round((now - startT)/60000) + " –º–∏–Ω";
        const stock_s = document.getElementById('stock-shelf').value;
        const stock_w = document.getElementById('stock-wh').value;

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ PDF —à–∞–±–ª–æ–Ω–∞
        document.getElementById('pdf-date').innerText = now.toLocaleString();
        document.getElementById('pdf-net').innerText = CUR.net;
        document.getElementById('pdf-addr').innerText = CUR.addr;
        document.getElementById('pdf-worker').innerText = DATA.user;
        document.getElementById('pdf-dur').innerText = dur;
        document.getElementById('pdf-time').innerText = `${startT.toLocaleTimeString()} - ${now.toLocaleTimeString()}`;
        
        document.getElementById('pdf-stock').innerText = parseInt(stock_s) + parseInt(stock_w);
        document.getElementById('pdf-s-shelf').innerText = stock_s;
        document.getElementById('pdf-s-wh').innerText = stock_w;
        
        document.getElementById('pdf-share').innerText = document.getElementById('share-val').innerText;
        document.getElementById('pdf-faces').innerText = document.getElementById('faces-mine').value;
        document.getElementById('pdf-prices').innerText = `${document.getElementById('price-our').value} / ${document.getElementById('price-comp').value}`;
        document.getElementById('pdf-exp').innerText = document.getElementById('exp-date').value;
        
        document.getElementById('pdf-img1').src = IMGS.pre;
        document.getElementById('pdf-img2').src = IMGS.post;
        document.getElementById('pdf-img3').src = IMGS.price;

        // –†–µ–Ω–¥–µ—Ä PDF
        setTimeout(async () => {
            const canvas = await html2canvas(document.getElementById('pdf-render'));
            const pdfData = canvas.toDataURL('image/jpeg', 0.7);
            
            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞: –°–ï–¢–¨_–ê–î–†–ï–°
            const safeName = `${CUR.net}_${CUR.addr}`.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_');

            const report = {
                worker: DATA.user,
                net: CUR.net,
                address: CUR.addr,
                city: CUR.city,
                stock_shelf: stock_s,
                stock_wh: stock_w,
                faces: document.getElementById('faces-mine').value,
                share: document.getElementById('share-val').innerText,
                ourPrice: document.getElementById('price-our').value,
                compPrice: document.getElementById('price-comp').value,
                expDate: document.getElementById('exp-date').value,
                pdf: pdfData,
                pdfName: safeName, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                startTime: startT.toLocaleTimeString(),
                endTime: now.toLocaleTimeString(),
                duration: dur,
                lat: CUR.lat || 0, lon: CUR.lon || 0,
                created: Date.now()
            };

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
            const tx = db.transaction('reports', 'readwrite');
            tx.objectStore('reports').add(report);
            
            CUR.done = true;
            CUR.data = { date: now.toLocaleDateString(), duration: dur, s_shelf: stock_s, s_wh: stock_w };
            localStorage.setItem('mx_shops', JSON.stringify(DATA.shops));
            
            alert("–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å!");
            closeModal();
            renderList();
            sync(); // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        }, 500);
    }

    // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (–û–ß–ï–†–ï–î–¨) ---
    function initDB() {
        const r = indexedDB.open("MerchX_DB", 2);
        r.onupgradeneeded = e => {
            const d = e.target.result;
            if(!d.objectStoreNames.contains('reports')) d.createObjectStore('reports', {keyPath:'id', autoIncrement:true});
        };
        r.onsuccess = e => {
            db = e.target.result;
            updateQ();
            setInterval(sync, 10000); // –ê–≤—Ç–æ-—Å–∏–Ω–∫ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
        };
    }

    function updateQ() {
        if(!db) return;
        db.transaction('reports').objectStore('reports').count().onsuccess = e => {
            const c = e.target.result;
            const ind = document.getElementById('syncIndicator');
            ind.style.display = c > 0 ? 'block' : 'none';
            document.getElementById('qCount').innerText = c;
        };
    }

    async function sync() {
        if(!db || !navigator.onLine) return;
        const tx = db.transaction('reports', 'readonly');
        tx.objectStore('reports').openCursor().onsuccess = async e => {
            const cur = e.target.result;
            if(cur) {
                const item = cur.value;
                try {
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    const res = await fetch(API_URL + '/merch-upload', {
                        method: 'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify(item)
                    });
                    if(res.ok) {
                        const delTx = db.transaction('reports', 'readwrite');
                        delTx.objectStore('reports').delete(cur.key);
                        updateQ();
                    }
                } catch(err) { console.log("Sync wait..."); }
                cur.continue();
            }
        };
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã (–µ—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –∑–∞–∫—Ä—ã–ª–∏)
    function restoreForm() {
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º, –ø–æ–ª—è –ø—É—Å—Ç—ã–µ
    }
</script>
</body>
</html>
