<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOGIST_X | MERCH PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg: #000000; --card: #111111; --accent: #f59e0b; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; }
        
        /* –û–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        
        .header { background: var(--bg); padding: 20px 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 15px; }
        .logo span { color: var(--accent); }
        
        .stats-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; }
        .s-v { display: block; font-size: 1.1rem; font-weight: 800; }
        .s-t { font-size: 0.6rem; text-transform: uppercase; opacity: 0.5; margin-top: 4px; font-weight: 700; }
        
        /* –ö–æ—Ä–æ–±–æ—á–∫–∞ –∫–∞–∫ –≤ –õ–æ–≥–∏—Å—Ç X */
        #syncIndicator { background: var(--accent); color: #000; padding: 6px 14px; border-radius: 20px; font-weight: 900; font-size: 0.7rem; border: none; cursor: pointer; display: none; }
        
        .btn-blue { background: var(--blue); color: white; padding: 16px; border-radius: 14px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 10px; text-decoration: none; }
        #srch { width: calc(100% - 30px); margin: 10px 15px; padding: 14px; background: var(--card); border: 1px solid var(--border); color: white; border-radius: 12px; box-sizing: border-box; }
        
        .card { background: var(--card); border: 1px solid var(--border); margin: 10px 15px; padding: 18px; border-radius: 16px; position: relative; }
        .card-net { font-size: 0.7rem; color: var(--accent); font-weight: 800; text-transform: uppercase; }
        .card-addr { font-size: 1rem; font-weight: 600; }
        .dot { position: absolute; right: 18px; top: 18px; width: 10px; height: 10px; border-radius: 50%; background: #222; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .m-form { background: #000; width: 100%; max-width: 420px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); box-sizing: border-box; max-height: 95vh; overflow-y: auto; }
        .f-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; }
        input { width: 100%; padding: 14px; background: #111; border: 1px solid var(--border); color: white; border-radius: 12px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
        
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .cam-btn { background: #111; border: 1px solid var(--border); height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.55rem; font-weight: 800; color: #666; cursor: pointer; }
        .cam-btn.ok { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.05); }
        
        #pdf-render { position: absolute; left: -9999px; width: 600px; background: #fff; color: #000; padding: 40px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="width:100%;">
        <center><div class="logo">LOGIST_X <span>MERCH</span></div></center>
        <input type="text" id="lic-key" placeholder="–ö–ª—é—á" style="text-align:center; margin-bottom:10px;">
        <input type="text" id="work-name" placeholder="–¢–≤–æ–µ –ò–º—è" style="text-align:center; margin-bottom:15px;">
        <div class="btn-blue" onclick="saveAuth()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</div>
    </div>
</div>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="logo">LOGIST_X <span>MERCH</span></div>
        <button id="syncIndicator" onclick="alert('–í –æ—á–µ—Ä–µ–¥–∏: ' + queueCount)">üì¶ <span id="qCount">0</span></button>
    </div>
    <div class="stats-main">
        <div class="s-box"><span class="s-v" id="st-total">0</span><span class="s-t">–¢–æ—á–µ–∫</span></div>
        <div class="s-box"><span class="s-v" id="st-done" style="color:var(--green)">0</span><span class="s-t">–í–∏–∑–∏—Ç–æ–≤</span></div>
    </div>
    <div style="display:flex; gap:10px;">
        <label class="btn-blue" for="file-in" style="flex:1;">–ü–õ–ê–ù (.XLSX)</label>
        <div class="btn-blue" onclick="clearData()" style="flex:0.3; background:var(--red);">üóëÔ∏è</div>
    </div>
    <input type="file" id="file-in" class="hidden" onchange="handleFile(this)">
</div>

<input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É..." oninput="render()">
<div id="list"></div>

<div id="task-modal" class="modal">
    <div class="m-form">
        <div id="m-net" style="color:var(--accent); font-weight:800; font-size:0.8rem; text-transform:uppercase;"></div>
        
        <div id="start-block">
            <div id="disp-addr" style="font-size: 1.2rem; font-weight: 700; margin: 15px 0;"></div>
            <button class="btn-blue" style="background:var(--green); color:black;" onclick="begin()">–ù–ê–ß–ê–¢–¨ –í–ò–ó–ò–¢</button>
        </div>

        <div id="report-block" class="hidden">
            <span class="f-label">–ê–¥—Ä–µ—Å —Ç–æ—á–∫–∏</span>
            <input type="text" id="inp-addr" readonly>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–û—Å—Ç–∞—Ç–æ–∫</span><input type="number" id="i-stock" value="0"></div>
                <div><span class="f-label">–§–µ–π—Å–∏–Ω–≥</span><input type="number" id="i-shelf" value="0"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–¶–µ–Ω–∞ –ú—ã</span><input type="number" id="i-p1" placeholder="0"></div>
                <div><span class="f-label">–¶–µ–Ω–∞ –ö–æ–Ω–∫.</span><input type="number" id="i-p2" placeholder="0"></div>
            </div>
            <span class="f-label">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</span>
            <input type="date" id="i-exp">
            
            <span class="f-label">–§–æ—Ç–æ–æ—Ç—á–µ—Ç (3 —Ñ–æ—Ç–æ)</span>
            <div class="photo-grid">
                <label class="cam-btn" id="l-p1" for="c-p1">üì∏<br>–î–û</label>
                <input type="file" id="c-p1" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'pre')">
                <label class="cam-btn" id="l-p2" for="c-p2">üì∏<br>–ü–û–°–õ–ï</label>
                <input type="file" id="c-p2" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'post')">
                <label class="cam-btn" id="l-p3" for="c-p3">üì∏<br>–¶–ï–ù–ù–ò–ö</label>
                <input type="file" id="c-p3" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'price')">
            </div>
            <button class="btn-blue" id="finish-btn" style="background:var(--green); color:black; margin-top:20px;" onclick="saveToQueue()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
        </div>
        <button class="btn-blue" style="background:none; color:#555;" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="pdf-render">
    <div style="display:flex; justify-content:space-between; border-bottom:5px solid #000; padding-bottom:10px;">
        <div style="font-size:28px; font-weight:900;">LOGIST_X <span style="color:#f59e0b">MERCH</span></div>
        <div id="p-date"></div>
    </div>
    <div style="margin-top:25px;">
        <div id="p-net" style="color:#f59e0b; font-weight:800; font-size:18px;"></div>
        <div id="p-addr-val" style="font-size:26px; font-weight:900;"></div>
        <div id="p-worker"></div>
        <div style="margin-top:5px; font-size:13px; font-weight:900; background:#f59e0b; color:#000; padding:8px; border-radius:4px; display:inline-block;">
            –í–†–ï–ú–Ø –ü–†–û–í–ï–î–ï–ù–ù–û–ï –í –ú–ê–ì–ê–ó–ò–ù–ï: <span id="p-dur"></span>
        </div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:25px;">
        <div style="background:#f4f4f4; padding:20px; border-radius:15px;">
            <div style="font-size:32px; font-weight:900;"><span id="p-stock"></span> / <span id="p-shelf"></span></div>
            <div id="p-exp-val" style="color:#ff3b30; font-weight:800;"></div>
        </div>
        <div style="background:#f4f4f4; padding:20px; border-radius:15px;">
            <div style="font-size:28px; font-weight:900;"><span id="p-p1"></span> / <span id="p-p2"></span></div>
        </div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:30px;">
        <img id="p-i1" style="width:100%; border-radius:10px;">
        <img id="p-i2" style="width:100%; border-radius:10px;">
        <img id="p-i3" style="width:100%; border-radius:10px;">
    </div>
</div>

<script>
    const API = 'https://logist-x-server-production.up.railway.app';
    let DATA = { shops: [], name: "", key: "" };
    let IMGS = { pre: null, post: null, price: null };
    let cur = null, db, syncing = false, queueCount = 0;

    function openDB() {
        const req = indexedDB.open("MerchX_Queue_v2", 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore("reports", { autoIncrement: true });
        req.onsuccess = (e) => { db = e.target.result; updateQueueUI(); sync(); };
    }

    window.onload = () => {
        DATA.name = localStorage.getItem('m_name') || "";
        DATA.key = localStorage.getItem('m_key') || "";
        if(DATA.key && DATA.name) document.getElementById('auth-screen').style.display='none';
        
        DATA.shops = JSON.parse(localStorage.getItem('m_shops') || "[]");
        openDB();
        render();
        setInterval(sync, 15000);
    };

    function saveAuth() {
        const n = document.getElementById('work-name').value.trim();
        const k = document.getElementById('lic-key').value.trim().toUpperCase();
        if(!n || !k) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–ª—é—á!");
        DATA.name = n; DATA.key = k;
        localStorage.setItem('m_name', n);
        localStorage.setItem('m_key', k);
        document.getElementById('auth-screen').style.display='none';
    }

    function render() {
        const list = document.getElementById('list');
        const search = document.getElementById('srch').value.toLowerCase();
        document.getElementById('st-total').innerText = DATA.shops.length;
        document.getElementById('st-done').innerText = DATA.shops.filter(s => s.done).length;
        
        list.innerHTML = DATA.shops.filter(s => s.addr.toLowerCase().includes(search)).map(s => `
            <div class="card" onclick="openModal(${s.id})">
                <div class="dot" style="background:${s.done ? 'var(--green)' : (s.start ? 'var(--blue)' : '#222')}"></div>
                <div class="card-net">${s.net}</div>
                <div class="card-addr">${s.addr}</div>
            </div>`).join('');
    }

    function openModal(id) {
        cur = DATA.shops.find(s => s.id === id);
        if(cur.done) return alert("–í–∏–∑–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
        document.getElementById('disp-addr').innerText = cur.addr;
        document.getElementById('inp-addr').value = cur.addr;
        document.getElementById('m-net').innerText = cur.net;
        document.getElementById('task-modal').style.display = 'flex';
        if(cur.start) {
            document.getElementById('start-block').classList.add('hidden');
            document.getElementById('report-block').classList.remove('hidden');
        } else {
            document.getElementById('start-block').classList.remove('hidden');
            document.getElementById('report-block').classList.add('hidden');
        }
    }

    function begin() {
        cur.start = new Date().getTime();
        localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
        render();
        document.getElementById('start-block').classList.add('hidden');
        document.getElementById('report-block').classList.remove('hidden');
    }

    async function saveToQueue() {
        if(!IMGS.pre || !IMGS.post || !IMGS.price) return alert("–ù—É–∂–Ω—ã –≤—Å–µ 3 —Ñ–æ—Ç–æ!");
        const btn = document.getElementById('finish-btn');
        btn.innerText = "–°–ë–û–†–ö–ê PDF..."; btn.disabled = true;

        const dur = Math.round((new Date().getTime() - cur.start) / 60000) + " –º–∏–Ω";
        
        document.getElementById('p-date').innerText = new Date().toLocaleString();
        document.getElementById('p-net').innerText = cur.net;
        document.getElementById('p-addr-val').innerText = cur.addr;
        document.getElementById('p-worker').innerText = DATA.name;
        document.getElementById('p-dur').innerText = dur;
        document.getElementById('p-stock').innerText = document.getElementById('i-stock').value;
        document.getElementById('p-shelf').innerText = document.getElementById('i-shelf').value;
        document.getElementById('p-p1').innerText = document.getElementById('i-p1').value;
        document.getElementById('p-p2').innerText = document.getElementById('i-p2').value;
        document.getElementById('p-exp-val').innerText = "–°–†–û–ö: " + (document.getElementById('i-exp').value || "-");
        document.getElementById('p-i1').src = IMGS.pre;
        document.getElementById('p-i2').src = IMGS.post;
        document.getElementById('p-i3').src = IMGS.price;

        const canvas = await html2canvas(document.getElementById('pdf-render'), { scale: 1 });
        const finalImg = canvas.toDataURL('image/jpeg', 0.7);

        const report = {
            action: 'merch_report',
            worker: DATA.name,
            license: DATA.key,
            net: cur.net,
            address: cur.addr,
            stock: document.getElementById('i-stock').value,
            faces: document.getElementById('i-shelf').value,
            expDate: document.getElementById('i-exp').value,
            duration: dur,
            pdf: finalImg,
            timestamp: Date.now()
        };

        const tx = db.transaction("reports", "readwrite");
        tx.objectStore("reports").add(report);
        
        tx.oncomplete = () => {
            cur.done = true;
            localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
            btn.disabled = false; btn.innerText = "–ó–ê–í–ï–†–®–ò–¢–¨";
            closeModal(); render(); updateQueueUI(); sync();
        };
    }

    async function sync() {
        if(syncing || !navigator.onLine || !db) return;
        syncing = true;
        const tx = db.transaction("reports", "readwrite");
        const store = tx.objectStore("reports");
        const req = store.openCursor();
        req.onsuccess = async (e) => {
            const cursor = e.target.result;
            if (cursor) {
                try {
                    const res = await fetch(`${API}/merch-upload`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(cursor.value)
                    });
                    const resJ = await res.json();
                    if(resJ.success) { cursor.delete(); updateQueueUI(); }
                } catch(err) {}
                cursor.continue();
            } else { syncing = false; updateQueueUI(); }
        };
    }

    function updateQueueUI() {
        const tx = db.transaction("reports", "readonly");
        tx.objectStore("reports").count().onsuccess = (e) => {
            queueCount = e.target.result;
            document.getElementById('syncIndicator').style.display = queueCount > 0 ? 'block' : 'none';
            document.getElementById('qCount').innerText = queueCount;
        };
    }

    function cam(input, type) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height, max = 800;
                if(w > h) { if(w > max) { h *= max/w; w = max; } } else { if(h > max) { w *= max/h; h = max; } }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                IMGS[type] = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById('l-p' + (type==='pre'?1:type==='post'?2:3)).classList.add('ok');
            };
        };
        reader.readAsDataURL(file);
    }

    function handleFile(inp) {
        const f = inp.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            DATA.shops = rows.map((r, idx) => ({
                id: idx,
                net: r['–°–µ—Ç—å'] || '–ú–ê–†–ö–ï–¢',
                addr: r['–ê–¥—Ä–µ—Å'] || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',
                done: false,
                start: null
            }));
            localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
            render();
        };
        reader.readAsArrayBuffer(f);
    }

    function closeModal() {
        document.getElementById('task-modal').style.display='none';
        IMGS = { pre:null, post:null, price:null };
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('ok'));
        document.getElementById('i-exp').value = "";
    }

    function clearData() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
