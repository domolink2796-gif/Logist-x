<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOGIST_X | MERCH PRO</title>
    <!-- –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #000000; --card: #111111; --accent: #f59e0b; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        
        /* –®–∞–ø–∫–∞ */
        .header { background: var(--bg); padding: 20px 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 15px; }
        .logo span { color: var(--accent); }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; }
        .s-v { display: block; font-size: 1.1rem; font-weight: 800; }
        .s-t { font-size: 0.6rem; text-transform: uppercase; opacity: 0.5; margin-top: 4px; font-weight: 700; }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        #syncIndicator { background: var(--accent); color: #000; padding: 8px 16px; border-radius: 20px; font-weight: 900; font-size: 0.75rem; border: none; cursor: pointer; display: none; margin-left: auto; }
        .btn-blue { background: var(--blue); color: white; padding: 16px; border-radius: 14px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 10px; text-decoration: none; }
        #srch { width: calc(100% - 30px); margin: 10px 15px; padding: 14px; background: var(--card); border: 1px solid var(--border); color: white; border-radius: 12px; box-sizing: border-box; font-size: 16px; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ */
        .card { background: var(--card); border: 1px solid var(--border); margin: 10px 15px; padding: 18px; border-radius: 16px; position: relative; }
        .card-net { font-size: 0.7rem; color: var(--accent); font-weight: 800; text-transform: uppercase; }
        .card-addr { font-size: 1rem; font-weight: 600; margin-top: 4px; }
        .dot { position: absolute; right: 18px; top: 18px; width: 10px; height: 10px; border-radius: 50%; background: #222; }
        
        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .m-form { background: #000; width: 100%; max-width: 420px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); box-sizing: border-box; max-height: 95vh; overflow-y: auto; }
        .f-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; }
        input { width: 100%; padding: 14px; background: #111; border: 1px solid var(--border); color: white; border-radius: 12px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
        
        /* –§–æ—Ç–æ –∏ –ü–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã */
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .cam-btn { background: #111; border: 1px solid var(--border); height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.55rem; font-weight: 800; color: #666; cursor: pointer; }
        .cam-btn.ok { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.05); }
        .plan-box { margin: 15px 0; padding: 12px; border: 1px dashed var(--accent); border-radius: 14px; background: rgba(245, 158, 11, 0.03); text-align: center; }
        
        /* --- SMART SCANNER UI --- */
        .smart-scanner-box { border: 1px solid #333; border-radius: 24px; padding: 15px; margin-top: 20px; background: #080808; position: relative; }
        .scanner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .scanner-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .scan-btn { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 14px; font-size: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .scan-btn.active-shelf { border-color: var(--blue); color: var(--blue); background: rgba(0,122,255,0.15); }
        .scan-btn.active-stock { border-color: var(--accent); color: var(--accent); background: rgba(245,158,11,0.15); }
        
        #reader { width: 100%; border-radius: 20px; overflow: hidden; margin-top: 10px; display: none; border: 2px solid #333; background: #000; }
        .scanner-active #reader { display: block; }

        .toggle-mode { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; background: #111; padding: 8px; border-radius: 12px; border: 1px solid #222; }
        .toggle-mode label { font-size: 10px; font-weight: 800; opacity: 0.6; }
        
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(14px); }

        #scan-popup { position: absolute; top: 10px; left: 10px; right: 10px; background: var(--green); color: #000; padding: 10px; border-radius: 12px; font-size: 11px; font-weight: 800; text-align: center; z-index: 100; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        .item-row { background: #141414; padding: 14px; border-radius: 18px; margin-bottom: 10px; border: 1px solid #222; position: relative; transition: all 0.3s; }
        .item-row.highlight { border-color: var(--green); background: rgba(0,255,0,0.05); }
        
        .item-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .mini-box { background: #1a1a1a; padding: 8px; border-radius: 12px; border: 1px solid #222; position: relative; text-align: center; }
        .mini-label { font-size: 7px; font-weight: 900; opacity: 0.4; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .mini-inp { background: transparent !important; border: none !important; padding: 0 !important; margin: 0 !important; text-align: center !important; font-size: 18px !important; font-weight: 900 !important; width: 100% !important; color: white; }
        
        .shelf-text { color: var(--blue) !important; }
        .stock-text { color: var(--accent) !important; }
        
        /* PDF Render (—Å–∫—Ä—ã—Ç—ã–π) */
        #pdf-render { position: absolute; left: -9999px; width: 600px; background: #fff; color: #000; padding: 40px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
<div id="auth-screen">
    <div style="width:100%;">
        <center><div class="logo">LOGIST_X <span>MERCH</span></div></center>
        <input type="text" id="lic-key" placeholder="–ö–ª—é—á –õ–∏—Ü–µ–Ω–∑–∏–∏" style="text-align:center; margin-bottom:10px;">
        <input type="text" id="work-name" placeholder="–¢–≤–æ–µ –ò–º—è" style="text-align:center; margin-bottom:15px;">
        <div id="auth-btn" class="btn-blue" onclick="saveAuth()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –°–ò–°–¢–ï–ú–£</div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="logo">LOGIST_X <span>MERCH</span></div>
        <button id="syncIndicator" onclick="checkQueue()">üì¶ <span id="qCount">0</span></button>
    </div>
    <div class="stats-main">
        <div class="s-box"><span class="s-v" id="st-total">0</span><span class="s-t">–¢–æ—á–µ–∫</span></div>
        <div class="s-box"><span class="s-v" id="st-done" style="color:var(--green)">0</span><span class="s-t">–í–∏–∑–∏—Ç–æ–≤</span></div>
    </div>
    <div style="display:flex; gap:10px;">
        <label class="btn-blue" for="file-in" style="flex:1;">–ó–ê–ì–†–£–ó–ò–¢–¨ –ü–õ–ê–ù (.xlsx)</label>
        <div class="btn-blue" onclick="clearData()" style="flex:0.3; background:var(--red);">üóëÔ∏è</div>
    </div>
    <input type="file" id="file-in" class="hidden" onchange="handleFile(this)">
</div>

<input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É..." oninput="render()">
<div id="list"></div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤–∏–∑–∏—Ç–∞ -->
<div id="task-modal" class="modal">
    <div class="m-form">
        <div id="m-net" style="color:var(--accent); font-weight:800; font-size:0.7rem; text-transform:uppercase;"></div>
        
        <!-- –ë–ª–æ–∫ –ü–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã -->
        <div id="planogram-section" class="plan-box">
            <div id="plan-btn-box"><span style="font-size:10px; opacity:0.5;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º...</span></div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ -->
        <div id="start-block">
            <div id="disp-addr" style="font-size: 1.2rem; font-weight: 800; margin: 15px 0;"></div>
            <button class="btn-blue" id="begin-btn" style="background:var(--green); color:black;" onclick="begin()">–û–¢–ö–†–´–¢–¨ –í–ò–ó–ò–¢</button>
        </div>

        <!-- –§–æ—Ä–º–∞ –æ—Ç—á–µ—Ç–∞ -->
        <div id="report-block" class="hidden">
            <span class="f-label">–ê–¥—Ä–µ—Å —Ç–æ—á–∫–∏</span>
            <input type="text" id="inp-addr" readonly>
            
            <!-- SMART SCANNER PRO v2.2 -->
            <div class="smart-scanner-box" id="scanner-container">
                <div id="scan-popup"></div>
                <div class="scanner-header">
                    <span style="font-size:0.6rem; font-weight:900; opacity:0.3;">CLOUD SCANNER PRO</span>
                    <span id="scan-mode-label" style="font-size:0.6rem; color:var(--accent); font-weight:900;"></span>
                </div>
                <div class="scanner-controls">
                    <button class="scan-btn" id="btn-shelf" onclick="toggleScanner('shelf')">üì∏ –ü–û–õ–ö–ê</button>
                    <button class="scan-btn" id="btn-stock" onclick="toggleScanner('stock')">üì∏ –°–ö–õ–ê–î</button>
                </div>
                
                <div class="toggle-mode">
                    <label>–†–ï–ñ–ò–ú –°–ß–ï–¢–ê (+1)</label>
                    <label class="switch">
                        <input type="checkbox" id="count-mode-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div id="reader"></div>
                <div id="scanned-list" style="margin-top:15px; max-height:350px; overflow-y:auto;">
                    <!-- –°—é–¥–∞ –ø–∞–¥–∞—é—Ç —Ç–æ–≤–∞—Ä—ã -->
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–û–±—â–∏–π –û—Å—Ç–∞—Ç–æ–∫</span><input type="number" id="i-stock" value="0"></div>
                <div><span class="f-label">–§–µ–π—Å–∏–Ω–≥ (–Ω–∞—à)</span><input type="number" id="i-faces" value="0" oninput="calcShare()"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–¶–µ–Ω–∞ (–ù–∞—à–∞)</span><input type="number" id="i-our-price" value="0" step="0.1"></div>
                <div><span class="f-label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç</span><input type="number" id="i-comp-price" value="0" step="0.1"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–í—Å–µ–≥–æ –Ω–∞ –ø–æ–ª–∫–µ</span><input type="number" id="i-total-faces" value="0" oninput="calcShare()"></div>
                <div style="text-align:center;"><span class="f-label">–î–æ–ª—è %</span><div style="color:var(--accent); font-weight:900; font-size:1.4rem; margin-top:8px;"><span id="share-val">0</span>%</div></div>
            </div>
            
            <span class="f-label">–§–æ—Ç–æ–æ—Ç—á–µ—Ç (3—à—Ç)</span>
            <div class="photo-grid">
                <label class="cam-btn" id="l-p1" for="c-p1">üì∏<br>–î–û</label><input type="file" id="c-p1" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'pre')">
                <label class="cam-btn" id="l-p2" for="c-p2">üì∏<br>–ü–û–°–õ–ï</label><input type="file" id="c-p2" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'post')">
                <label class="cam-btn" id="l-p3" for="c-p3">üì∏<br>–¶–ï–ù–ù–ò–ö</label><input type="file" id="c-p3" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'price')">
            </div>
            <button class="btn-blue" id="finish-btn" style="background:var(--green); color:black; margin-top:20px;" onclick="saveToQueue()">–ó–ê–í–ï–†–®–ò–¢–¨ –í–ò–ó–ò–¢</button>
        </div>

        <!-- –ê—Ä—Ö–∏–≤–Ω—ã–π –±–ª–æ–∫ -->
        <div id="archive-block" class="hidden">
            <div class="arch-view">
                <div id="arch-addr-title" style="font-size:1.1rem; font-weight:900; margin-bottom:10px;"></div>
                <div id="arch-details" style="font-size:0.8rem; line-height:1.5; color:#888;"></div>
                <div id="arch-items" style="margin-top:15px; border-top:1px solid #222; padding-top:10px;"></div>
                <div id="arch-photos" class="photo-grid" style="margin-top:15px;"></div>
                <button class="btn-blue" style="margin-top:20px; background:var(--blue);" onclick="startNewVisit()">üîÑ –ü–û–í–¢–û–†–ù–´–ô –í–ò–ó–ò–¢</button>
            </div>
        </div>
        <button class="btn-blue" style="background:none; color:#444; margin-top:15px;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä PDF (—Å–∫—Ä—ã—Ç—ã–π) -->
<div id="pdf-render">
    <div style="display:flex; justify-content:space-between; border-bottom:5px solid #000; padding-bottom:15px;">
        <div style="font-size:36px; font-weight:900;">LOGIST_X <span style="color:#f59e0b">MERCH</span></div>
        <div style="font-size:14px; text-align:right; opacity:0.6;" id="p-date"></div>
    </div>
    <div style="margin-top:25px;">
        <div id="p-net" style="color:#f59e0b; font-weight:800; font-size:18px; text-transform:uppercase;"></div>
        <div id="p-addr-val" style="font-size:32px; font-weight:900; margin-top:5px;"></div>
        <div style="font-size:18px; margin-top:10px;">–ú–µ—Ä—á–∞–Ω–¥–∞–π–∑–µ—Ä: <span id="p-worker" style="font-weight:800;"></span></div>
        <div id="p-items-summary" style="margin-top:20px; font-size:12px; border:2px solid #eee; padding:15px; border-radius:15px; background:#fafafa;"></div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px; margin-top:30px;">
        <div style="background:#f0f0f0; padding:30px; border-radius:25px;">
            <div style="font-size:12px; font-weight:800; opacity:0.5;">–û–°–¢–ê–¢–û–ö / –§–ï–ô–°–ò–ù–ì</div>
            <div style="font-size:48px; font-weight:900; margin:15px 0;"><span id="p-stock"></span> / <span id="p-faces"></span></div>
            <div style="font-size:12px; font-weight:800; opacity:0.5;">–î–û–õ–Ø –ü–û–õ–ö–ò</div>
            <div style="font-size:36px; font-weight:900; color:#f59e0b;"><span id="p-share"></span>%</div>
        </div>
        <div style="background:#f0f0f0; padding:30px; border-radius:25px;">
            <div style="font-size:12px; font-weight:800; opacity:0.5;">–¶–ï–ù–´ (–ú–´ / –ö–û–ù–ö)</div>
            <div style="font-size:36px; font-weight:900; margin:20px 0;"><span id="p-our-price"></span> / <span id="p-comp-price"></span></div>
        </div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-top:40px;">
        <img id="p-i1" style="width:100%; border-radius:15px; aspect-ratio:3/4; object-fit:cover;">
        <img id="p-i2" style="width:100%; border-radius:15px; aspect-ratio:3/4; object-fit:cover;">
        <img id="p-i3" style="width:100%; border-radius:15px; aspect-ratio:3/4; object-fit:cover;">
    </div>
</div>

<script>
    const API = 'https://logist-x-server-production.up.railway.app';
    let DATA = { shops: [], name: "", key: "" }, IMGS = { pre: null, post: null, price: null }, cur = null, db, syncing = false;
    
    // SCANNER LOGIC
    let PRODUCT_CATALOG = {}; 
    let SHOP_BALANCES = {};   
    let CURRENT_ITEMS = [];   
    let html5QrCode = null;
    let scanMode = null; 
    let lastScannedCode = null;
    let lastScanTime = 0;

    function speak(t) { const m = new SpeechSynthesisUtterance(); m.text = t; m.lang = 'ru-RU'; window.speechSynthesis.speak(m); }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
    async function loadProductCatalog() {
        if(!DATA.key) return;
        try {
            const res = await fetch(`${API}/get-catalog?key=${DATA.key}`);
            if(res.ok) PRODUCT_CATALOG = await res.json();
        } catch(e) {}
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
    async function fetchShopStock(addr) {
        if(!DATA.key) return;
        try {
            const res = await fetch(`${API}/get-shop-stock?key=${DATA.key}&addr=${encodeURIComponent(addr)}`);
            if(res.ok) SHOP_BALANCES = await res.json();
            else SHOP_BALANCES = {};
        } catch(e) { SHOP_BALANCES = {}; }
    }

    function toggleScanner(mode) {
        const box = document.getElementById('scanner-container');
        const label = document.getElementById('scan-mode-label');
        if(scanMode === mode) { stopScanner(); } 
        else {
            if(scanMode) stopScanner();
            scanMode = mode;
            box.classList.add('scanner-active');
            document.getElementById(mode === 'shelf' ? 'btn-shelf' : 'btn-stock').classList.add(mode === 'shelf' ? 'active-shelf' : 'active-stock');
            label.innerText = mode === 'shelf' ? "–†–ï–ñ–ò–ú: –ü–û–õ–ö–ê" : "–†–ï–ñ–ò–ú: –°–ö–õ–ê–î";
            startScanner();
        }
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 300, height: 120 } }, (bc) => {
            processBarcode(bc.trim());
        }).catch(() => {
            let bc = prompt("–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥:");
            if(bc) processBarcode(bc.trim());
            stopScanner();
        });
    }

    function stopScanner() {
        scanMode = null;
        document.getElementById('scanner-container').classList.remove('scanner-active');
        document.querySelectorAll('.scan-btn').forEach(b => { b.classList.remove('active-shelf'); b.classList.remove('active-stock'); });
        document.getElementById('scan-mode-label').innerText = "";
        if(html5QrCode) { html5QrCode.stop().then(() => html5QrCode = null).catch(() => {}); }
    }

    function showScanPopup(text, isNew = false) {
        const p = document.getElementById('scan-popup');
        p.innerText = text; p.style.background = isNew ? "var(--accent)" : "var(--green)";
        p.style.display = 'block'; setTimeout(() => { p.style.display = 'none'; }, 2000);
    }

    async function processBarcode(bc) {
        const now = Date.now();
        // –ó–ê–©–ò–¢–ê –û–¢ –î–†–ï–ë–ï–ó–ì–ê: 2 —Å–µ–∫ –ø–∞—É–∑–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –∫–æ–¥–∞
        if(bc === lastScannedCode && (now - lastScanTime) < 2000) return;
        
        lastScannedCode = bc;
        lastScanTime = now;

        let product = PRODUCT_CATALOG[bc];
        let lastKnownStock = SHOP_BALANCES[bc] || 0; 
        const isCountMode = document.getElementById('count-mode-toggle').checked;
        
        if(product) {
            showScanPopup(`${product.name}\n–ë–´–õ–û –¢–£–¢: ${lastKnownStock} —à—Ç.`);
            speak(product.name);
            addItemToVisit(bc, product.name, lastKnownStock, isCountMode);
        } else {
            stopScanner();
            let name = prompt(`–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä (${bc})! –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:`);
            if(name) {
                PRODUCT_CATALOG[bc] = { name: name };
                addItemToVisit(bc, name, 0, true);
                await fetch(`${API}/save-product`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: DATA.key, barcode: bc, name: name })
                });
            }
        }
    }

    function addItemToVisit(bc, name, lastStock, increment) {
        let existing = CURRENT_ITEMS.find(i => i.bc === bc);
        if(existing) {
            if(increment) {
                if(scanMode === 'shelf') existing.shelf++;
                if(scanMode === 'stock') existing.stock++;
            }
            highlightItem(bc);
        } else {
            CURRENT_ITEMS.unshift({ bc, name, lastStock, shelf: scanMode === 'shelf' ? 1 : 0, stock: scanMode === 'stock' ? 1 : 0 });
        }
        renderScannedList();
        updateGlobalTotals();
    }

    function highlightItem(bc) {
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(r => {
            if(r.dataset.bc === bc) {
                r.classList.add('highlight');
                r.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => r.classList.remove('highlight'), 1000);
            }
        });
    }

    function renderScannedList() {
        const cont = document.getElementById('scanned-list');
        cont.innerHTML = CURRENT_ITEMS.map(i => `
            <div class="item-row" data-bc="${i.bc}">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div class="item-name">${i.name}</div>
                    <div class="item-bc">${i.bc}</div>
                </div>
                <div class="item-inputs">
                    <div class="mini-box"><span class="mini-label">–ù–∞ –ø–æ–ª–∫–µ</span><input type="number" class="mini-inp shelf-text" value="${i.shelf}" oninput="updateManual('${i.bc}', 'shelf', this.value)"></div>
                    <div class="mini-box"><span class="mini-label">–ù–∞ —Å–∫–ª–∞–¥–µ</span><input type="number" class="mini-inp stock-text" value="${i.stock}" oninput="updateManual('${i.bc}', 'stock', this.value)"><span style="font-size:7px; opacity:0.3; position:absolute; bottom:2px; right:5px;">–ë–´–õ–û –¢–£–¢: ${i.lastStock}</span></div>
                </div>
            </div>
        `).join('');
    }

    function updateManual(bc, field, val) {
        let itm = CURRENT_ITEMS.find(i => i.bc === bc);
        if(itm) itm[field] = parseInt(val) || 0;
        updateGlobalTotals();
    }

    function updateGlobalTotals() {
        let tShelf = 0, tStock = 0;
        CURRENT_ITEMS.forEach(i => { tShelf += i.shelf; tStock += i.stock; });
        document.getElementById('i-faces').value = tShelf;
        document.getElementById('i-stock').value = tShelf + tStock;
        calcShare();
    }

    // --- DB & AUTH ---

    function openDB() {
        const req = indexedDB.open("MerchX_Final_Sync", 7);
        req.onupgradeneeded = (e) => { 
            const dbRef = e.target.result; 
            if(!dbRef.objectStoreNames.contains("reports")) dbRef.createObjectStore("reports", { keyPath: "id", autoIncrement: true });
            if(!dbRef.objectStoreNames.contains("archive")) dbRef.createObjectStore("archive", { keyPath: "shop_addr" });
        };
        req.onsuccess = (e) => { db = e.target.result; updateQueueUI(); setInterval(sync, 8000); };
    }

    window.onload = () => {
        DATA.name = localStorage.getItem('m_name') || ""; 
        DATA.key = localStorage.getItem('m_key') || "";
        if(DATA.key && DATA.name) { document.getElementById('auth-screen').style.display='none'; loadProductCatalog(); }
        DATA.shops = JSON.parse(localStorage.getItem('m_shops') || "[]"); openDB(); render();
    };

    async function saveAuth() {
        const n = document.getElementById('work-name').value.trim(), k = document.getElementById('lic-key').value.trim().toUpperCase();
        if(!n || !k) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
        try {
            const res = await fetch(`${API}/check-license`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ licenseKey: k, workerName: n }) });
            const d = await res.json();
            if(d.status === 'active') { DATA.name = n; DATA.key = k; localStorage.setItem('m_name', n); localStorage.setItem('m_key', k); document.getElementById('auth-screen').style.display='none'; loadProductCatalog(); } 
            else alert(d.message);
        } catch(e) { alert("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); }
    }

    function calcShare() {
        const mine = parseFloat(document.getElementById('i-faces').value) || 0, total = parseFloat(document.getElementById('i-total-faces').value) || 0;
        document.getElementById('share-val').innerText = total > 0 ? Math.round((mine / total) * 100) : 0;
    }

    function render() {
        const list = document.getElementById('list'), s = document.getElementById('srch').value.toLowerCase();
        document.getElementById('st-total').innerText = DATA.shops.length; document.getElementById('st-done').innerText = DATA.shops.filter(x => x.done).length;
        list.innerHTML = DATA.shops.filter(x => x.addr.toLowerCase().includes(s)).map(x => `
            <div class="card" onclick="openModal(${x.id})">
                <div class="dot" style="background:${x.done ? 'var(--green)' : (x.start ? 'var(--blue)' : '#222')}"></div>
                <div class="card-net">${x.net}</div>
                <div class="card-addr">${x.addr} ${x.done ? '<span style="color:var(--green); font-size:10px;">[–ê–†–•–ò–í]</span>' : ''}</div>
            </div>
        `).join('');
    }

    function openModal(id) {
        cur = DATA.shops.find(x => x.id === id); 
        document.getElementById('m-net').innerText = cur.net;
        document.getElementById('task-modal').style.display = 'flex';
        checkPlanogram(cur.addr); 
        if(cur.done) {
            document.getElementById('start-block').classList.add('hidden');
            document.getElementById('report-block').classList.add('hidden');
            document.getElementById('archive-block').classList.remove('hidden');
            loadArchive(cur.addr);
        } else if(cur.start) {
            document.getElementById('inp-addr').value = cur.addr;
            document.getElementById('start-block').classList.add('hidden');
            document.getElementById('report-block').classList.remove('hidden');
            document.getElementById('archive-block').classList.add('hidden');
            renderScannedList();
        } else {
            document.getElementById('disp-addr').innerText = cur.addr;
            document.getElementById('start-block').classList.remove('hidden');
            document.getElementById('report-block').classList.add('hidden');
            document.getElementById('archive-block').classList.add('hidden');
            CURRENT_ITEMS = []; 
        }
    }

    async function begin() { 
        const btn = document.getElementById('begin-btn');
        const oldText = btn.innerText;
        btn.innerText = "–°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –û–ë–õ–ê–ö–ê..."; btn.disabled = true;
        
        await fetchShopStock(cur.addr);
        
        cur.start = Date.now(); 
        localStorage.setItem('m_shops', JSON.stringify(DATA.shops)); 
        render(); openModal(cur.id); 
        speak("–î–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã."); 
        btn.innerText = oldText; btn.disabled = false;
    }

    async function saveToQueue() {
        if(!IMGS.pre || !IMGS.post || !IMGS.price) return alert("–ù—É–∂–Ω–æ 3 —Ñ–æ—Ç–æ");
        const btn = document.getElementById('finish-btn'); 
        btn.innerText = "–ü–†–û–í–ï–†–ö–ê GPS..."; btn.disabled = true;
        
        const gpsOptions = { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 };

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const now = new Date();
            const startT = new Date(cur.start).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const dur = Math.max(1, Math.round((now - cur.start) / 60000)) + " –ú–ò–ù";
            
            document.getElementById('p-date').innerText = now.toLocaleString();
            document.getElementById('p-start-t').innerText = startT; 
            document.getElementById('p-addr-val').innerText = cur.addr; 
            document.getElementById('p-worker').innerText = DATA.name;
            document.getElementById('p-stock').innerText = document.getElementById('i-stock').value;
            document.getElementById('p-faces').innerText = document.getElementById('i-faces').value;
            document.getElementById('p-share').innerText = document.getElementById('share-val').innerText;
            document.getElementById('p-our-price').innerText = document.getElementById('i-our-price').value;
            document.getElementById('p-comp-price').innerText = document.getElementById('i-comp-price').value;
            document.getElementById('p-i1').src = IMGS.pre; document.getElementById('p-i2').src = IMGS.post; document.getElementById('p-i3').src = IMGS.price;
            document.getElementById('p-items-summary').innerHTML = CURRENT_ITEMS.map(i => `${i.name}(${i.shelf}/${i.stock})`).join('; ');

            setTimeout(async () => {
                const canvas = await html2canvas(document.getElementById('pdf-render'), { scale: 1 });
                const report = { 
                    key: DATA.key, worker: DATA.name, net: cur.net, city: cur.city, address: cur.addr, 
                    stock: document.getElementById('i-stock').value, faces: document.getElementById('i-faces').value, 
                    ourPrice: document.getElementById('i-our-price').value, compPrice: document.getElementById('i-comp-price').value,
                    share: document.getElementById('share-val').innerText, startTime: startT, endTime: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), duration: dur, 
                    items: CURRENT_ITEMS, pdf: canvas.toDataURL('image/jpeg', 0.5), sending: 0 
                };
                const tx = db.transaction(["reports", "archive"], "readwrite");
                tx.objectStore("reports").add(report);
                tx.objectStore("archive").put({ shop_addr: cur.addr, ...report, img_pre: IMGS.pre, img_post: IMGS.post, img_price: IMGS.price });
                tx.oncomplete = () => { 
                    cur.done = true; localStorage.setItem('m_shops', JSON.stringify(DATA.shops)); 
                    closeModal(); render(); sync(); speak("–í–∏–∑–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ç—á–µ—Ç –≤ –æ—á–µ—Ä–µ–¥–∏."); 
                    btn.innerText = "–ó–ê–í–ï–†–®–ò–¢–¨ –í–ò–ó–ò–¢"; btn.disabled = false;
                };
            }, 500);
        }, (err) => { 
            btn.disabled = false; btn.innerText = "–ó–ê–í–ï–†–®–ò–¢–¨ –í–ò–ó–ò–¢";
            alert("–û—à–∏–±–∫–∞ GPS: –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ—Å—Ç–µ.");
        }, gpsOptions);
    }

    async function sync() {
        if(syncing || !navigator.onLine || !db) return; syncing = true;
        const tx = db.transaction("reports", "readwrite");
        tx.objectStore("reports").openCursor().onsuccess = async (e) => {
            const cursor = e.target.result;
            if(cursor) {
                const report = cursor.value; if(report.sending) { cursor.continue(); return; }
                report.sending = 1; cursor.update(report);
                try {
                    const res = await fetch(`${API}/merch-upload`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(report) });
                    if(res.ok) { db.transaction("reports", "readwrite").objectStore("reports").delete(cursor.key); }
                    else { report.sending = 0; cursor.update(report); }
                } catch(err) { report.sending = 0; cursor.update(report); }
                syncing = false; updateQueueUI();
            } else syncing = false;
        };
    }

    function startNewVisit() {
        if(confirm("–ù–∞—á–∞—Ç—å –≤–∏–∑–∏—Ç –∑–∞–Ω–æ–≤–æ?")) {
            cur.done = false; cur.start = null; IMGS = { pre:null, post:null, price:null };
            CURRENT_ITEMS = []; renderScannedList();
            document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('ok'));
            localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
            render(); openModal(cur.id);
        }
    }

    function loadArchive(addr) {
        document.getElementById('arch-addr-title').innerText = addr;
        db.transaction("archive", "readonly").objectStore("archive").get(addr).onsuccess = (e) => {
            const d = e.target.result; if(!d) return;
            document.getElementById('arch-details').innerHTML = `–í–∏–∑–∏—Ç: ${d.startTime}-${d.endTime} (${d.duration})<br>–û—Å—Ç–∞—Ç–æ–∫: ${d.stock} | –î–æ–ª—è: ${d.share}%`;
            if(d.items) document.getElementById('arch-items').innerHTML = `<div style="font-size:10px; opacity:0.3;">–î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø:</div>` + d.items.map(i => `<div style="font-size:0.7rem; border-bottom:1px solid #222; padding:4px 0; display:flex; justify-content:space-between;"><span>${i.name}</span><span>${i.shelf}/${i.stock}</span></div>`).join('');
            document.getElementById('arch-photos').innerHTML = `<img src="${d.img_pre}" style="width:100%; border-radius:12px;"><img src="${d.img_post}" style="width:100%; border-radius:12px;"><img src="${d.img_price}" style="width:100%; border-radius:12px;">`;
        };
    }

    function updateQueueUI() { if(!db) return; db.transaction("reports", "readonly").objectStore("reports").count().onsuccess = (e) => { document.getElementById('syncIndicator').style.display = e.target.result > 0 ? 'block' : 'none'; document.getElementById('qCount').innerText = e.target.result; }; }
    function checkQueue() { alert("–í –æ—á–µ—Ä–µ–¥–∏: " + document.getElementById('qCount').innerText); }
    
    // –°–∂–∞—Ç–∏–µ —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    function cam(i, t) { 
        if(!i.files[0]) return; 
        const r = new FileReader(); 
        r.onload = (e) => { 
            const img = new Image(); 
            img.src = e.target.result; 
            img.onload = () => { 
                const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                const maxW = 800;
                let w = img.width, h = img.height;
                if(w > maxW) { h *= maxW/w; w = maxW; }
                c.width = w; c.height = h; 
                ctx.drawImage(img, 0, 0, w, h); 
                IMGS[t] = c.toDataURL('image/jpeg', 0.6); 
                document.getElementById(t==='pre'?'l-p1':(t==='post'?'l-p2':'l-p3')).classList.add('ok'); 
            }; 
        }; r.readAsDataURL(i.files[0]); 
    }

    async function checkPlanogram(addr) {
        const box = document.getElementById('plan-btn-box');
        try {
            const res = await fetch(`${API}/get-planogram?city=${encodeURIComponent(cur.city)}&addr=${encodeURIComponent(addr)}&key=${encodeURIComponent(DATA.key)}`);
            const d = await res.json();
            if(d.exists) box.innerHTML = `<button class="btn-blue" style="background:var(--accent); color:#000; padding:10px; font-size:12px;" onclick="window.open('${d.url || d.webContentLink}', '_blank')">–°–•–ï–ú–ê –ü–õ–ê–ù–û–ì–†–ê–ú–ú–´</button>`;
            else box.innerHTML = `<label class="btn-blue" for="up-plan" style="background:#222; border:1px solid #333; padding:10px; font-size:12px;">üì∏ –ü–†–ò–í–Ø–ó–ê–¢–¨ –°–•–ï–ú–£</label><input type="file" id="up-plan" accept="image/*" capture="camera" class="hidden" onchange="uploadPlanogram(this)">`;
        } catch(e) { box.innerHTML = '<span style="font-size:10px; color:red;">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏</span>'; }
    }

    async function uploadPlanogram(inp) { if(!inp.files[0]) return; document.getElementById('plan-btn-box').innerHTML = '–ó–ê–ì–†–£–ó–ö–ê...'; const r = new FileReader(); r.onload = async (e) => { const img = new Image(); img.src = e.target.result; img.onload = async () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); c.width = 1000; c.height = img.height * (1000/img.width); ctx.drawImage(img, 0, 0, c.width, c.height); await fetch(`${API}/upload-planogram`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ city: cur.city, addr: cur.addr, key: DATA.key, image: c.toDataURL('image/jpeg', 0.6) }) }); checkPlanogram(cur.addr); }; }; r.readAsDataURL(inp.files[0]); }
    function handleFile(inp) { const r = new FileReader(); r.onload = (e) => { const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); DATA.shops = rows.map((r, i) => ({ id: i, net: r['–°–µ—Ç—å'] || '–ú–ê–†–ö–ï–¢', city: r['–ì–æ—Ä–æ–¥'] || '–û—Ä—ë–ª', addr: r['–ê–¥—Ä–µ—Å'] || '?', lat: parseFloat(r['–®–∏—Ä–æ—Ç–∞']) || 0, lon: parseFloat(r['–î–æ–ª–≥–æ—Ç–∞']) || 0, done: false, start: null })); localStorage.setItem('m_shops', JSON.stringify(DATA.shops)); render(); }; r.readAsArrayBuffer(inp.files[0]); }
    function closeModal() { document.getElementById('task-modal').style.display='none'; stopScanner(); }
    function clearData() { if(confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ, –ø–ª–∞–Ω—ã –∏ –ª–∏—Ü–µ–Ω–∑–∏—é. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) { localStorage.clear(); indexedDB.deleteDatabase("MerchX_Final_Sync"); location.reload(); } }
</script>
</body>
</html>

