<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOGIST_X | MERCH PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --bg: #000000; --card: #111111; --accent: #ffffff; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --gold: #f59e0b; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        .header { background: var(--bg); padding: 20px 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 15px; }
        .logo span { color: var(--gold); }
        .stats-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; }
        .s-v { display: block; font-size: 1.1rem; font-weight: 800; }
        .s-t { font-size: 0.6rem; text-transform: uppercase; opacity: 0.5; margin-top: 4px; font-weight: 700; }
        .btn-blue { background: var(--blue); color: white; padding: 16px; border-radius: 14px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 10px; }
        #srch { width: calc(100% - 30px); margin: 10px 15px; padding: 14px; background: var(--card); border: 1px solid var(--border); color: white; border-radius: 12px; box-sizing: border-box; }
        .card { background: var(--card); border: 1px solid var(--border); margin: 10px 15px; padding: 18px; border-radius: 16px; position: relative; }
        .card-net { font-size: 0.7rem; color: var(--gold); font-weight: 800; text-transform: uppercase; }
        .card-addr { font-size: 1rem; font-weight: 600; }
        .dot { position: absolute; right: 18px; top: 18px; width: 10px; height: 10px; border-radius: 50%; background: #222; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .m-form { background: #000; width: 100%; max-width: 420px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); box-sizing: border-box; max-height: 95vh; overflow-y: auto; }
        .f-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; }
        input { width: 100%; padding: 14px; background: #111; border: 1px solid var(--border); color: white; border-radius: 12px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .cam-btn { background: #111; border: 1px solid var(--border); height: 75px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.55rem; font-weight: 800; color: #666; cursor: pointer; }
        .cam-btn.ok { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.05); }
        #pdf-render { position: absolute; left: -9999px; width: 600px; background: #fff; color: #000; padding: 40px; box-sizing: border-box; }
        .hidden { display: none; }
        .gps-status { font-size: 10px; margin-top: 10px; text-align: center; color: var(--gold); }
        .btn-start { background: var(--green); color: black; margin-top: 15px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="width:100%;">
        <center><div class="logo">LOGIST_X <span>MERCH</span></div></center>
        <input type="text" id="license-key-field" placeholder="–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –∫–ª—é—á" style="text-align:center; margin-bottom:10px;">
        <input type="text" id="worker-name-field" placeholder="–í–∞—à–µ –ò–º—è" style="text-align:center; margin-bottom:15px;">
        <div class="btn-blue" id="login-btn" onclick="startApp()">–í–•–û–î</div>
    </div>
</div>

<div class="header">
    <div class="logo">LOGIST_X <span>MERCH</span></div>
    <div class="stats-main">
        <div class="s-box"><span class="s-v" id="st-total">0</span><span class="s-t">–¢–æ—á–µ–∫</span></div>
        <div class="s-box"><span class="s-v" id="st-done" style="color:var(--green)">0</span><span class="s-t">–í–∏–∑–∏—Ç–æ–≤</span></div>
    </div>
    <div id="user-info" style="font-size: 10px; opacity: 0.5; margin-bottom: 10px; text-transform: uppercase;"></div>
    <label class="btn-blue" for="file-in">–ó–ê–ì–†–£–ó–ò–¢–¨ –ü–õ–ê–ù (.XLSX)</label>
    <input type="file" id="file-in" class="hidden" onchange="processFile(this)">
</div>

<input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞..." oninput="render()">
<div id="list"></div>

<div id="task-modal" class="modal">
    <div class="m-form">
        <div id="m-net" style="color:var(--gold); font-weight:800; font-size:0.8rem; text-transform:uppercase;"></div>
        
        <div id="visit-start-block">
            <span class="f-label">–ê–¥—Ä–µ—Å —Ç–æ—á–∫–∏</span>
            <div id="display-address" style="font-size: 1.1rem; font-weight: 700; margin: 10px 0;"></div>
            <div id="gps-msg" class="gps-status" style="margin-bottom: 15px;"></div>
            <button class="btn-blue btn-start" onclick="beginVisit()">–ù–ê–ß–ê–¢–¨ –í–ò–ó–ò–¢</button>
        </div>

        <div id="visit-report-block" class="hidden">
            <span class="f-label">–£–ª–∏—Ü–∞</span>
            <input type="text" id="inp-street">
            <span class="f-label">–î–æ–º / –ü–æ–¥—ä–µ–∑–¥</span>
            <input type="text" id="inp-house">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–û—Å—Ç–∞—Ç–æ–∫</span><input type="number" id="inp-stock" value="0"></div>
                <div><span class="f-label">–§–µ–π—Å–∏–Ω–≥</span><input type="number" id="inp-shelf" value="0"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–¶–µ–Ω–∞ –ú–´</span><input type="number" id="inp-price-my" placeholder="0"></div>
                <div><span class="f-label">–¶–µ–Ω–∞ –ö–û–ù–ö.</span><input type="number" id="inp-price-comp" placeholder="0"></div>
            </div>
            <span class="f-label">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</span>
            <input type="date" id="inp-date-exp">
            <span class="f-label">–§–æ—Ç–æ–æ—Ç—á–µ—Ç</span>
            <div class="photo-grid">
                <label class="cam-btn" id="lbl-pre" for="cam-pre">üì∏<br>–î–û</label>
                <input type="file" id="cam-pre" accept="image/*" capture="camera" class="hidden" onchange="compressImg(this, 'pre')">
                <label class="cam-btn" id="lbl-post" for="cam-post">üì∏<br>–ü–û–°–õ–ï</label>
                <input type="file" id="cam-post" accept="image/*" capture="camera" class="hidden" onchange="compressImg(this, 'post')">
                <label class="cam-btn" id="lbl-price" for="cam-price">üì∏<br>–¶–ï–ù–ù–ò–ö</label>
                <input type="file" id="cam-price" accept="image/*" capture="camera" class="hidden" onchange="compressImg(this, 'price')">
            </div>
            <button class="btn-blue" id="send-btn" style="background:var(--green); color:black; margin-top:20px;" onclick="generateAndSend()">–ó–ê–í–ï–†–®–ò–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
        
        <button class="btn-blue" style="background:none; color:#555;" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="pdf-render">
    <div style="display:flex; justify-content:space-between; border-bottom:5px solid #000; padding-bottom:10px;">
        <div style="font-size:28px; font-weight:900;">LOGIST_X <span style="color:#f59e0b">MERCH</span></div>
        <div id="p-date" style="font-size:14px;"></div>
    </div>
    <div style="margin-top:25px;">
        <div id="p-net" style="color:#f59e0b; font-weight:800; font-size:18px; text-transform:uppercase;"></div>
        <div id="p-addr" style="font-size:26px; font-weight:900; margin: 5px 0;"></div>
        <div id="p-worker" style="font-size:14px; opacity:0.7;"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:30px;">
        <div style="background:#f4f4f4; padding:20px; border-radius:15px;">
            <div style="font-size:11px; opacity:0.6; font-weight:bold;">–û–°–¢–ê–¢–û–ö / –§–ï–ô–°–ò–ù–ì</div>
            <div style="font-size:32px; font-weight:900;"><span id="p-stock">0</span> / <span id="p-shelf">0</span></div>
            <div style="font-size:11px; opacity:0.6; font-weight:bold; margin-top:20px;">–°–†–û–ö –ì–û–î–ù–û–°–¢–ò</div>
            <div id="p-exp" style="font-size:22px; font-weight:900; color:#ff3b30;">-</div>
        </div>
        <div style="background:#f4f4f4; padding:20px; border-radius:15px;">
            <div style="font-size:11px; opacity:0.6; font-weight:bold;">–¶–ï–ù–´ (–ú–´ / –ö–û–ù–ö–£–†–ï–ù–¢)</div>
            <div style="font-size:28px; font-weight:900;"><span id="p-p-my">0</span> / <span id="p-p-comp">0</span></div>
        </div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-top:40px; text-align:center;">
        <div><div style="font-weight:900; font-size:14px; margin-bottom:10px;">–§–û–¢–û –î–û</div><img id="p-img1" style="width:100%; height:200px; object-fit:cover; border-radius:12px;"></div>
        <div><div style="font-weight:900; font-size:14px; margin-bottom:10px;">–§–û–¢–û –ü–û–°–õ–ï</div><img id="p-img2" style="width:100%; height:200px; object-fit:cover; border-radius:12px;"></div>
        <div><div style="font-weight:900; font-size:14px; margin-bottom:10px;">–¶–ï–ù–ù–ò–ö</div><img id="p-img3" style="width:100%; height:200px; object-fit:cover; border-radius:12px;"></div>
    </div>
</div>

<script>
    const API_BASE = 'https://logist-x-server-production.up.railway.app';
    let STATE = { shops: [], current: null, worker: "", key: "" };
    let IMGS = { pre: null, post: null, price: null };

    window.onload = () => {
        const savedKey = localStorage.getItem('merch_key');
        const savedName = localStorage.getItem('merch_name');
        if(savedKey) document.getElementById('license-key-field').value = savedKey;
        if(savedName) document.getElementById('worker-name-field').value = savedName;
    };

    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function startApp() {
        const key = document.getElementById('license-key-field').value.trim();
        const name = document.getElementById('worker-name-field').value.trim();
        if(!key || !name) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
        const btn = document.getElementById('login-btn');
        btn.innerText = "–ü–†–û–í–ï–†–ö–ê...";
        try {
            const res = await fetch(`${API_BASE}/check-license`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ licenseKey: key, workerName: name })
            });
            const data = await res.json();
            if(data.status === 'active') {
                STATE.key = key; STATE.worker = name;
                localStorage.setItem('merch_key', key);
                localStorage.setItem('merch_name', name);
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('user-info').innerText = "–°–æ—Ç—Ä—É–¥–Ω–∏–∫: " + name;
            } else { alert("–û—à–∏–±–∫–∞: " + (data.message || "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á")); }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
        btn.innerText = "–í–•–û–î";
    }

    function processFile(inp) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            const head = rows[0].map(v => String(v || "").toLowerCase());
            const idxA = head.findIndex(v => v.includes('–∞–¥—Ä–µ—Å'));
            const idxN = head.findIndex(v => v.includes('—Å–µ—Ç—å') || v.includes('–º–∞–≥–∞–∑–∏–Ω'));
            const idxLat = head.findIndex(v => v.includes('—à–∏—Ä–æ—Ç–∞') || v.includes('lat'));
            const idxLon = head.findIndex(v => v.includes('–¥–æ–ª–≥–æ—Ç–∞') || v.includes('lon'));

            STATE.shops = rows.slice(1).filter(r => r[idxA]).map((r, i) => ({
                id: i, addr: r[idxA], net: idxN !== -1 ? r[idxN] : "–¢–¢", 
                targetLat: idxLat !== -1 ? parseFloat(String(r[idxLat]).replace(',', '.')) : null,
                targetLon: idxLon !== -1 ? parseFloat(String(r[idxLon]).replace(',', '.')) : null,
                done: false
            }));
            render();
        };
        reader.readAsArrayBuffer(inp.files[0]);
    }

    function openModal(id) {
        STATE.current = STATE.shops.find(s => s.id === id);
        document.getElementById('m-net').innerText = STATE.current.net;
        document.getElementById('display-address').innerText = STATE.current.addr;
        document.getElementById('inp-street').value = STATE.current.addr;
        document.getElementById('gps-msg').innerText = STATE.current.targetLat ? "üìç –ö–æ–Ω—Ç—Ä–æ–ª—å GPS –≤–∫–ª—é—á–µ–Ω" : "‚ö†Ô∏è –ü–ª–∞–Ω –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç";
        
        // –°–±—Ä–æ—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –±–ª–æ–∫–æ–≤
        document.getElementById('visit-start-block').classList.remove('hidden');
        document.getElementById('visit-report-block').classList.add('hidden');
        document.getElementById('task-modal').style.display = 'flex';
    }

    function beginVisit() {
        STATE.current.startTime = new Date().toLocaleTimeString("ru-RU");
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –±–ª–æ–∫–∏
        document.getElementById('visit-start-block').classList.add('hidden');
        document.getElementById('visit-report-block').classList.remove('hidden');
        console.log("–í–∏–∑–∏—Ç –Ω–∞—á–∞—Ç –≤:", STATE.current.startTime);
    }

    async function compressImg(el, type) {
        const file = el.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const w = 800; canvas.width = w; canvas.height = (img.height/img.width)*w;
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                IMGS[type] = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('lbl-'+type).classList.add('ok');
            };
        };
        reader.readAsDataURL(file);
    }

    async function generateAndSend() {
        if(!IMGS.pre || !IMGS.post || !IMGS.price) return alert("–ù—É–∂–Ω—ã –≤—Å–µ 3 —Ñ–æ—Ç–æ!");
        const btn = document.getElementById('send-btn');
        btn.innerText = "–ü–†–û–í–ï–†–ö–ê GPS..."; btn.disabled = true;

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const uLat = pos.coords.latitude; const uLon = pos.coords.longitude;
            if (STATE.current.targetLat && STATE.current.targetLon) {
                const distance = getDist(uLat, uLon, STATE.current.targetLat, STATE.current.targetLon);
                if (distance > 500) {
                    alert(`–û–®–ò–ë–ö–ê –ì–ï–û: –í—ã —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ (${Math.round(distance)}–º).`);
                    btn.innerText = "–ó–ê–í–ï–†–®–ò–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨"; btn.disabled = false;
                    return;
                }
            }
            btn.innerText = "–°–ë–û–†–ö–ê –û–¢–ß–ï–¢–ê...";
            const street = document.getElementById('inp-street').value.trim();
            const house = document.getElementById('inp-house').value.trim();
            const finalAddr = street + " " + house;
            const endTime = new Date().toLocaleTimeString("ru-RU");

            document.getElementById('p-date').innerText = new Date().toLocaleString();
            document.getElementById('p-net').innerText = STATE.current.net;
            document.getElementById('p-addr').innerText = finalAddr;
            document.getElementById('p-worker').innerText = "–ú–µ—Ä—á–∞–Ω–¥–∞–π–∑–µ—Ä: " + STATE.worker;
            document.getElementById('p-stock').innerText = document.getElementById('inp-stock').value;
            document.getElementById('p-shelf').innerText = document.getElementById('inp-shelf').value;
            document.getElementById('p-p-my').innerText = document.getElementById('inp-price-my').value;
            document.getElementById('p-p-comp').innerText = document.getElementById('inp-price-comp').value;
            document.getElementById('p-exp').innerText = document.getElementById('inp-date-exp').value || "-";
            document.getElementById('p-img1').src = IMGS.pre; document.getElementById('p-img2').src = IMGS.post; document.getElementById('p-img3').src = IMGS.price;

            try {
                const canvas = await html2canvas(document.getElementById('pdf-render'), { scale: 1.5 });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                pdf.addImage(canvas.toDataURL('image/jpeg', 0.7), 'JPEG', 0, 0, 210, 297);
                
                const res = await fetch(`${API_BASE}/merch-upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        worker: STATE.worker, net: STATE.current.net, address: finalAddr,
                        stock: document.getElementById('inp-stock').value,
                        shelf: document.getElementById('inp-shelf').value,
                        priceMy: document.getElementById('inp-price-my').value,
                        priceComp: document.getElementById('inp-price-comp').value,
                        expDate: document.getElementById('inp-date-exp').value,
                        startTime: STATE.current.startTime, endTime: endTime,
                        lat: uLat, lon: uLon, pdf: pdf.output('datauristring')
                    })
                });
                const result = await res.json();
                if(result.success) { alert("–û–¢–ß–ï–¢ –ü–†–ò–ù–Ø–¢"); STATE.current.done = true; closeModal(); render(); }
                else { alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + result.error); }
            } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            btn.innerText = "–ó–ê–í–ï–†–®–ò–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨"; btn.disabled = false;
        }, () => { alert("–û—à–∏–±–∫–∞: –í–∫–ª—é—á–∏—Ç–µ GPS!"); btn.innerText = "–ó–ê–í–ï–†–®–ò–¢–¨ –ò –û–¢–ü–†–ê–í–ò–¢–¨"; btn.disabled = false; }, { enableHighAccuracy: true });
    }

    function render() {
        const f = document.getElementById('srch').value.toLowerCase();
        document.getElementById('st-total').innerText = STATE.shops.length;
        document.getElementById('st-done').innerText = STATE.shops.filter(s => s.done).length;
        document.getElementById('list').innerHTML = STATE.shops.map(s => {
            if(f && !s.addr.toLowerCase().includes(f)) return '';
            return `<div class="card" onclick="openModal(${s.id})"><div class="dot" style="background:${s.done ? 'var(--green)' : '#222'}"></div><div class="card-net">${s.net}</div><div class="card-addr">${s.addr}</div></div>`;
        }).join('');
    }

    function closeModal() { document.getElementById('task-modal').style.display = 'none'; IMGS = { pre: null, post: null, price: null }; document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('ok')); }
</script>
</body>
</html>
