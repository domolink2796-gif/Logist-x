<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOGIST_X | MERCH PRO SMART</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #000000; --card: #111111; --accent: #f59e0b; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        .header { background: var(--bg); padding: 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.3rem; font-weight: 900; letter-spacing: -1px; }
        .logo span { color: var(--accent); }
        
        .btn-blue { background: var(--blue); color: white; padding: 16px; border-radius: 14px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        .btn-gold { background: var(--accent); color: #000; }
        input { width: 100%; padding: 14px; background: #111; border: 1px solid var(--border); color: white; border-radius: 12px; margin-top: 5px; font-size: 16px; box-sizing: border-box; outline: none; }

        .card { background: var(--card); border: 1px solid var(--border); margin: 10px 15px; padding: 18px; border-radius: 16px; position: relative; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .m-form { background: #000; width: 100%; max-width: 420px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); box-sizing: border-box; max-height: 98vh; overflow-y: auto; }

        /* –°–ö–ê–ù–ï–†-–ü–û–õ–û–°–ö–ê */
        .scan-overlay { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; }
        #reader { width: 100%; height: 200px; background: #000; }
        
        /* –°–¢–†–û–ö–ê –¢–û–í–ê–†–ê */
        .item-row { background: #111; border: 1px solid #222; border-radius: 15px; padding: 12px; margin-top: 10px; }
        .item-name { font-size: 13px; font-weight: 800; color: #fff; margin-bottom: 8px; display: block; line-height: 1.2; }
        .qty-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .qty-box { display: flex; flex-direction: column; }
        .qty-box span { font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 4px; text-align: center; font-weight: 700; }
        .qty-input { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 10px; text-align: center; color: var(--green); font-weight: 900; font-size: 18px; width: 100%; box-sizing: border-box; }

        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 15px; }
        .cam-btn { background: #111; border: 1px solid var(--border); height: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 10px; font-weight: 800; color: #666; }
        .cam-btn.ok { border-color: var(--green); color: var(--green); background: rgba(0,255,0,0.05); }

        /* –û–¢–ß–ï–¢ PDF */
        #pdf-render { position: absolute; left: -9999px; width: 600px; background: #fff; color: #000; padding: 40px; box-sizing: border-box; }
        .p-block { background: #f0f0f0; border-radius: 12px; padding: 15px; margin-top: 15px; }
        .p-orange-btn { background: #f59e0b; color: #000; padding: 10px 15px; border-radius: 8px; font-weight: 900; font-size: 12px; text-transform: uppercase; margin: 10px 0; display: inline-block; }
        .p-val { font-size: 32px; font-weight: 900; line-height: 1; }
        .p-label { font-size: 10px; font-weight: 800; opacity: 0.5; text-transform: uppercase; margin-bottom: 5px; }
        .p-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-family: sans-serif; }
        .p-table th { text-align: left; font-size: 10px; text-transform: uppercase; opacity: 0.5; padding: 5px; border-bottom: 1px solid #ddd; }
        .p-table td { padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 14px; font-weight: 700; }
        .hidden { display: none; }
        .f-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="width:100%; max-width: 300px;">
        <center><div class="logo">LOGIST_X <span>MERCH</span></div></center>
        <input type="text" id="lic-key" placeholder="–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –ö–ª—é—á" style="text-align:center; margin-bottom:10px;">
        <input type="text" id="work-name" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è" style="text-align:center; margin-bottom:15px;">
        <div class="btn-blue btn-gold" onclick="saveAuth()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</div>
    </div>
</div>

<div id="scan-overlay" class="scan-overlay">
    <div id="reader"></div>
    <div style="padding: 15px; background: #000; flex: 1;">
        <div id="scan-status" style="text-align:center; color:var(--accent); font-weight:bold; margin-bottom:15px; font-size: 12px; text-transform: uppercase;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –∫–æ–¥</div>
        
        <div style="background: #111; padding: 20px; border-radius: 20px; border: 1px solid #333;">
            <span style="font-size: 10px; color: #666; text-transform: uppercase; font-weight: 800;">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</span>
            <input type="text" id="new-prod-name" placeholder="–ù–∞–ø—Ä: Jacobs Monarch 200–≥">
            <button class="btn-blue btn-gold" style="margin-top:15px; margin-bottom: 0;" onclick="saveNewProduct()">–î–û–ë–ê–í–ò–¢–¨ –ò –°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
        
        <button class="btn-blue" style="background:#222; margin-top:20px;" onclick="closeScanner()">–ó–ê–ö–†–´–¢–¨ –°–ö–ê–ù–ï–†</button>
    </div>
</div>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="logo">LOGIST_X <span>MERCH</span></div>
        <div id="syncIndicator" style="background:var(--red); padding: 5px 10px; border-radius: 20px; font-size: 10px; display:none; font-weight: 800;">–û–¢–ü–†–ê–í–ö–ê: <span id="qCount">0</span></div>
    </div>
</div>

<input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ —Ç–æ—á–∫–∏..." oninput="render()" style="width: calc(100% - 30px); margin: 10px 15px;">
<div id="list"></div>

<div id="task-modal" class="modal">
    <div class="m-form">
        <div id="m-net" style="color:var(--accent); font-weight:900; font-size:11px; text-transform:uppercase;"></div>
        <div id="m-addr" style="font-size: 18px; font-weight: 800; margin-bottom: 15px;"></div>
        
        <div id="start-block">
            <button class="btn-blue btn-gold" style="height: 55px; font-size: 16px;" onclick="begin()">–û–¢–ö–†–´–¢–¨ –¢–û–ß–ö–£</button>
        </div>

        <div id="report-block" class="hidden">
            <button class="btn-blue" style="background:var(--accent); color:#000; font-size: 12px;" onclick="openScanner()">üì∑ –ü–†–û–°–ö–ê–ù–ò–†–û–í–ê–¢–¨ –¢–û–í–ê–†</button>
            <div id="items-container" style="margin: 15px 0;"></div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–§–µ–π—Å–∏–Ω–≥ –Ω–∞—à</span><input type="number" id="i-faces" value="0" oninput="calcShare()"></div>
                <div><span class="f-label">–§–µ–π—Å–∏–Ω–≥ –≤—Å–µ–≥–æ</span><input type="number" id="i-total-faces" value="0" oninput="calcShare()"></div>
            </div>
            <center><div style="color:var(--accent); font-weight:900; margin-top:5px;">–î–û–õ–Ø: <span id="share-val">0</span>%</div></center>
            
            <span class="f-label">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ (—Å—Ç–∞—Ä–µ–π—à–∏–π)</span>
            <input type="date" id="i-exp">

            <div class="photo-grid">
                <label class="cam-btn" id="l-p1">üì∏ –î–û<input type="file" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'pre')"></label>
                <label class="cam-btn" id="l-p2">üì∏ –ü–û–°–õ–ï<input type="file" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'post')"></label>
                <label class="cam-btn" id="l-p3">üì∏ –¶–ï–ù–ù–ò–ö<input type="file" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'price')"></label>
            </div>
            <button class="btn-blue" id="finish-btn" style="background:var(--green); color:black; margin-top:25px; height: 50px;" onclick="saveToQueue()">–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢</button>
        </div>
        <button class="btn-blue" style="background:none; color:#666;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="pdf-render">
    <div style="display:flex; justify-content:space-between; align-items: center; border-bottom: 3px solid #000; padding-bottom: 10px;">
        <div style="font-size: 26px; font-weight: 900; letter-spacing: -1px;">LOGIST_X <span style="color:#f59e0b">MERCH</span></div>
        <div style="font-size: 11px; opacity: 0.6;" id="p-date"></div>
    </div>
    <div style="margin-top: 20px;">
        <div id="p-net" style="color:#f59e0b; font-weight:800; font-size:13px; text-transform: uppercase;"></div>
        <div id="p-addr-val" style="font-size: 30px; font-weight: 900; line-height: 1.1;"></div>
        <div style="font-size: 14px; margin-top: 5px;">–ú–µ—Ä—á–µ–Ω–¥–∞–π–∑–µ—Ä: <span id="p-worker" style="font-weight: 700;"></span></div>
        <div class="p-orange-btn">–í–†–ï–ú–Ø –ü–†–û–í–ï–î–ï–ù–ù–û–ï –í –ú–ê–ì–ê–ó–ò–ù–ï: <span id="p-dur"></span></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="p-block"><div class="p-label">–î–æ–ª—è –ø–æ–ª–∫–∏ (%)</div><div class="p-val" id="p-share">0%</div></div>
            <div class="p-block"><div class="p-label">–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏</div><div class="p-val" id="p-exp" style="font-size: 20px; padding-top: 8px;">--.--.--</div></div>
        </div>
    </div>
    <table class="p-table">
        <thead><tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</th><th style="text-align:center;">–ü–æ–ª–∫–∞</th><th style="text-align:center;">–°–∫–ª–∞–¥</th></tr></thead>
        <tbody id="p-table-body"></tbody>
    </table>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:30px; text-align:center;">
        <div><div style="font-size:10px; font-weight:900; margin-bottom:5px;">–§–û–¢–û –î–û</div><img id="p-i1" style="width:100%; height: 120px; object-fit: cover; background: #000; border-radius: 8px;"></div>
        <div><div style="font-size:10px; font-weight:900; margin-bottom:5px;">–§–û–¢–û –ü–û–°–õ–ï</div><img id="p-i2" style="width:100%; height: 120px; object-fit: cover; background: #000; border-radius: 8px;"></div>
        <div><div style="font-size:10px; font-weight:900; margin-bottom:5px;">–¶–ï–ù–ù–ò–ö</div><img id="p-i3" style="width:100%; height: 120px; object-fit: cover; background: #000; border-radius: 8px;"></div>
    </div>
</div>

<script>
    const API = 'https://logist-x-server-production.up.railway.app';
    let DATA = { shops: [], name: "", key: "" }, IMGS = { pre: null, post: null, price: null }, cur = null, db;
    let CATALOG = []; let scanner = null, lastCode = '';

    function speak(t) { if ('speechSynthesis' in window) { const m = new SpeechSynthesisUtterance(t); m.lang = 'ru-RU'; window.speechSynthesis.speak(m); } }

    window.onload = () => {
        DATA.name = localStorage.getItem('m_name') || ""; DATA.key = localStorage.getItem('m_key') || "";
        if(DATA.key && DATA.name) { document.getElementById('auth-screen').style.display='none'; syncCatalog(); }
        DATA.shops = JSON.parse(localStorage.getItem('m_shops') || "[]");
        CATALOG = JSON.parse(localStorage.getItem('m_catalog') || "[]");
        initDB(); render();
    };

    async function syncCatalog() {
        try {
            const res = await fetch(`${API}/get-client-catalog?key=${DATA.key}`);
            if(res.ok) {
                const serverData = await res.json();
                if(serverData.length > 0) { CATALOG = serverData; localStorage.setItem('m_catalog', JSON.stringify(CATALOG)); }
            }
        } catch(e) {}
    }

    async function saveAuth() {
        const n = document.getElementById('work-name').value.trim(), k = document.getElementById('lic-key').value.trim().toUpperCase();
        if(!n || !k) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
        const res = await fetch(`${API}/check-license`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ licenseKey: k, workerName: n }) });
        const d = await res.json();
        if(d.status === 'active') { DATA.name = n; DATA.key = k; localStorage.setItem('m_name', n); localStorage.setItem('m_key', k); location.reload(); }
        else alert(d.message);
    }

    function render() {
        const list = document.getElementById('list'), s = document.getElementById('srch').value.toLowerCase();
        list.innerHTML = DATA.shops.filter(x => x.addr.toLowerCase().includes(s)).map(x => `
            <div class="card" onclick="openModal(${x.id})">
                <div style="font-size:10px; color:var(--accent); font-weight:800; text-transform:uppercase;">${x.net}</div>
                <div style="font-weight:600;">${x.addr}</div>
            </div>
        `).join('');
    }

    function openModal(id) {
        cur = DATA.shops.find(x => x.id === id); 
        document.getElementById('m-net').innerText = cur.net;
        document.getElementById('m-addr').innerText = cur.addr;
        document.getElementById('task-modal').style.display = 'flex';
        document.getElementById('start-block').classList.toggle('hidden', cur.active);
        document.getElementById('report-block').classList.toggle('hidden', !cur.active);
        if(cur.active) renderItems();
    }

    function begin() {
        cur.active = true; cur.start = Date.now();
        cur.pointStock = JSON.parse(localStorage.getItem('stock_' + cur.addr) || "{}");
        IMGS = { pre: null, post: null, price: null };
        document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('ok'));
        speak("–¢–æ—á–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞."); openModal(cur.id);
    }

    function renderItems() {
        const container = document.getElementById('items-container');
        if(CATALOG.length === 0) { container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:20px; font-size:12px;">–ë–∞–∑–∞ –ø—É—Å—Ç–∞.</div>'; return; }
        container.innerHTML = CATALOG.map(item => {
            const s = cur.pointStock[item.code]?.shelf || 0;
            const w = cur.pointStock[item.code]?.wh || 0;
            return `
            <div class="item-row">
                <span class="item-name">${item.name}</span>
                <div class="qty-grid">
                    <div class="qty-box"><span>–ü–æ–ª–∫–∞</span><input type="number" class="qty-input" value="${s}" oninput="updateStock('${item.code}', 'shelf', this.value)"></div>
                    <div class="qty-box"><span>–°–∫–ª–∞–¥</span><input type="number" class="qty-input" value="${w}" oninput="updateStock('${item.code}', 'wh', this.value)"></div>
                </div>
            </div>`;
        }).join('');
    }

    function updateStock(code, type, val) {
        if(!cur.pointStock[code]) cur.pointStock[code] = { shelf: 0, wh: 0 };
        cur.pointStock[code][type] = parseInt(val) || 0;
        localStorage.setItem('stock_' + cur.addr, JSON.stringify(cur.pointStock));
    }

    function openScanner() {
        document.getElementById('scan-overlay').style.display = 'flex';
        document.getElementById('new-prod-name').value = '';
        document.getElementById('scan-status').innerText = "–ù–ê–í–ï–î–ò–¢–ï –ö–ê–ú–ï–†–£ –ù–ê –ö–û–î";
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: {width: window.innerWidth * 0.8, height: 120} }, onScan);
    }

    async function onScan(code) {
        if(code === lastCode) return; lastCode = code;
        const r = await fetch(`${API}/check-barcode?code=${code}&key=${DATA.key}`);
        const d = await r.json();
        
        if(d.exists) { 
            if(!CATALOG.find(x => x.code === code)) { CATALOG.push({ code: code, name: d.name }); localStorage.setItem('m_catalog', JSON.stringify(CATALOG)); }
            speak(d.name); closeScanner(); renderItems();
        } else { 
            speak("–≠—Ç–æ –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä. –ü–æ–¥–ø–∏—à–∏—Ç–µ –µ–≥–æ."); 
            document.getElementById('scan-status').innerText = "–ö–û–î –†–ê–°–ü–û–ó–ù–ê–ù. –í–í–ï–î–ò–¢–ï –ù–ê–ó–í–ê–ù–ò–ï:";
            // –°—Ç–∞–≤–∏–º —Å–∫–∞–Ω–µ—Ä –Ω–∞ –ø–∞—É–∑—É, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –≤–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç
            if(scanner) scanner.pause(true);
        }
    }

    function saveNewProduct() {
        const name = document.getElementById('new-prod-name').value; 
        if(!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞!");
        
        const newObj = { code: lastCode || 'MANUAL_' + Date.now(), name: name };
        CATALOG.push(newObj); 
        localStorage.setItem('m_catalog', JSON.stringify(CATALOG));
        
        fetch(`${API}/update-client-catalog`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ key: DATA.key, product: newObj }) 
        });

        speak("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
        closeScanner(); 
        renderItems();
    }

    function closeScanner() { 
        if(scanner) {
            scanner.stop().then(() => {
                scanner.clear();
                document.getElementById('scan-overlay').style.display='none';
                lastCode = '';
            });
        } else {
            document.getElementById('scan-overlay').style.display='none';
            lastCode = '';
        }
    }

    function calcShare() {
        const m = document.getElementById('i-faces').value; const t = document.getElementById('i-total-faces').value;
        document.getElementById('share-val').innerText = t > 0 ? Math.round((m/t)*100) : 0;
    }

    async function saveToQueue() {
        if(!IMGS.pre || !IMGS.post) return alert("–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –î–û –∏ –ü–û–°–õ–ï!");
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const R = 6371e3; const a = Math.sin(((pos.coords.latitude-cur.lat)*Math.PI/180)/2)**2 + Math.cos(cur.lat*Math.PI/180)*Math.cos(pos.coords.latitude*Math.PI/180)*Math.sin(((pos.coords.longitude-cur.lon)*Math.PI/180)/2)**2;
            if(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) > 600) { speak("–°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç –º–∞–≥–∞–∑–∏–Ω–∞."); return; }
            
            const now = new Date();
            const dur = Math.round((now - cur.start) / 60000) + " –ú–ò–ù";
            document.getElementById('p-date').innerText = now.toLocaleString();
            document.getElementById('p-net').innerText = cur.net;
            document.getElementById('p-addr-val').innerText = cur.addr;
            document.getElementById('p-worker').innerText = DATA.name;
            document.getElementById('p-dur').innerText = dur;
            document.getElementById('p-share').innerText = document.getElementById('share-val').innerText + "%";
            const expVal = document.getElementById('i-exp').value;
            document.getElementById('p-exp').innerText = expVal ? expVal.split('-').reverse().join('.') : "--.--.--";
            document.getElementById('p-table-body').innerHTML = CATALOG.map(x => {
                const s = cur.pointStock[x.code]?.shelf || 0;
                const w = cur.pointStock[x.code]?.wh || 0;
                if(s===0 && w===0) return '';
                return `<tr><td>${x.name}</td><td style="text-align:center;">${s}</td><td style="text-align:center;">${w}</td></tr>`;
            }).join('');
            document.getElementById('p-i1').src = IMGS.pre; document.getElementById('p-i2').src = IMGS.post; document.getElementById('p-i3').src = IMGS.price || "";

            setTimeout(async () => {
                const canvas = await html2canvas(document.getElementById('pdf-render'));
                const report = { worker: DATA.name, address: cur.addr, pdf: canvas.toDataURL('image/jpeg', 0.6), created: Date.now() };
                db.transaction("reports", "readwrite").objectStore("reports").add(report);
                cur.active = false; localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
                speak("–ì–æ—Ç–æ–≤–æ."); closeModal(); render(); sync();
            }, 800);
        }, () => alert("–í–∫–ª—é—á–∏—Ç–µ GPS"));
    }

    function cam(i, t) {
        const r = new FileReader(); r.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const c = document.createElement('canvas'); const m = 1000; let w = img.width, h = img.height;
                if(w > h) { if(w > m) { h *= m/w; w = m; } } else { if(h > m) { w *= m/h; h = m; } }
                c.width = w; c.height = h; c.getContext('2d').drawImage(img, 0, 0, w, h);
                IMGS[t] = c.toDataURL('image/jpeg', 0.5); document.getElementById(t==='pre'?'l-p1':(t==='post'?'l-p2':'l-p3')).classList.add('ok');
            };
        }; r.readAsDataURL(i.files[0]);
    }

    function initDB() {
        const req = indexedDB.open("MerchX_Final_Sync", 30);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore("reports", { keyPath: "id", autoIncrement: true });
        req.onsuccess = (e) => { db = e.target.result; setInterval(sync, 15000); };
    }

    function sync() {
        if(!navigator.onLine) return;
        const tx = db.transaction("reports", "readwrite"), store = tx.objectStore("reports"), req = store.openCursor();
        req.onsuccess = async (e) => {
            const cursor = e.target.result;
            if(cursor) {
                const res = await fetch(`${API}/merch-upload`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(cursor.value) });
                if(res.ok) store.delete(cursor.key); cursor.continue();
            }
        };
    }
    function handleFile(inp) {
        const r = new FileReader(); r.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            DATA.shops = rows.map((r, i) => ({ id: i, net: r['–°–µ—Ç—å']||'?', addr: r['–ê–¥—Ä–µ—Å']||'?', lat: parseFloat(r['–®–∏—Ä–æ—Ç–∞'])||0, lon: parseFloat(r['–î–æ–ª–≥–æ—Ç–∞'])||0, active: false }));
            localStorage.setItem('m_shops', JSON.stringify(DATA.shops)); render();
        }; r.readAsArrayBuffer(inp.files[0]);
    }
    function closeModal() { document.getElementById('task-modal').style.display='none'; }
    function clearData() { if(confirm("–°–±—Ä–æ—Å?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
