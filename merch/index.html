<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MERCH X | PRO v2.2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #000000; --card: #111111; --accent: #f59e0b; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        
        .header { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); padding: 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 10px; }
        .logo span { color: var(--accent); }
        
        .stats-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 12px; text-align: center; }
        .s-v { display: block; font-size: 1.2rem; font-weight: 800; color: #fff; }
        .s-t { font-size: 0.6rem; text-transform: uppercase; opacity: 0.5; font-weight: 700; margin-top: 4px; }
        
        .btn-blue { background: var(--blue); color: white; padding: 14px; border-radius: 12px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 8px; font-size: 14px; }
        .btn-gold { background: var(--accent); color: #000; }
        input { width: 100%; padding: 14px; background: #1a1a1a; border: 1px solid var(--border); color: white; border-radius: 12px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }

        .card { background: var(--card); border: 1px solid var(--border); margin-bottom: 10px; padding: 15px; border-radius: 16px; position: relative; transition: 0.2s; }
        .card:active { transform: scale(0.98); background: #1a1a1a; }
        .card-net { font-size: 0.7rem; color: var(--accent); font-weight: 800; text-transform: uppercase; margin-bottom: 4px; }
        .card-addr { font-size: 0.95rem; font-weight: 600; line-height: 1.3; padding-right: 40px; }
        .dist-badge { position: absolute; top: 15px; right: 15px; font-size: 10px; font-weight: 800; background: #333; padding: 4px 8px; border-radius: 10px; color: #aaa; }
        .dot { position: absolute; right: 15px; bottom: 15px; width: 8px; height: 8px; border-radius: 50%; background: #333; }
        .dot.done { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .dot.active { background: var(--blue); }

        .modal { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; overflow-y: auto; }
        .m-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #000; z-index: 10; }
        .m-body { padding: 20px; padding-bottom: 100px; }
        .f-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; margin-bottom: 5px; }
        
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .cam-btn { background: #1a1a1a; border: 1px dashed #444; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; color: #666; font-size: 0.6rem; font-weight: 700; position: relative; }
        .cam-btn.ok { border: 1px solid var(--green); color: var(--green); background: rgba(0,255,0,0.1); }
        .plan-box { padding: 15px; border: 1px dashed var(--accent); border-radius: 14px; background: rgba(245, 158, 11, 0.05); text-align: center; margin-bottom: 20px; }

        .scan-overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .scan-view { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        .scan-ui { padding: 20px; background: #111; border-top: 1px solid var(--border); text-align: center; }
        .scan-frame { position: absolute; width: 70%; aspect-ratio: 1; border: 2px solid var(--accent); box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); border-radius: 20px; z-index: 10; pointer-events: none; }
        
        .scanned-item { background: #222; border-bottom: 1px solid #333; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        #qty-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 2px solid var(--accent); padding: 20px; border-radius: 20px; width: 80%; z-index: 2500; display: none; box-shadow: 0 0 50px rgba(0,0,0,1); text-align: center; }

        #syncIndicator { position: fixed; bottom: 20px; right: 20px; background: var(--red); color: #fff; padding: 10px 20px; border-radius: 30px; font-weight: 900; font-size: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; z-index: 500; }
        #pdf-render { position: absolute; left: -9999px; width: 800px; background: #fff; color: #000; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="logo" style="font-size:2rem; margin-bottom:30px;">MERCH <span>X</span></div>
    <input type="text" id="lic-key" placeholder="–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π –ö–ª—é—á" style="text-align:center;">
    <input type="text" id="work-name" placeholder="–í–∞—à–µ –ò–º—è (–§–∞–º–∏–ª–∏—è)" style="text-align:center;">
    <button class="btn-blue btn-gold" onclick="auth()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
</div>

<div id="scan-overlay" class="scan-overlay">
    <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; background:#000;">
        <div style="font-weight:900; font-size:18px;">SCANNER</div>
        <div onclick="closeScanner()" style="font-size:24px;">‚úï</div>
    </div>
    <div class="scan-view">
        <div id="reader"></div>
        <div class="scan-frame"></div>
        <div id="qty-popup">
            <div id="qty-title" style="color:var(--accent); font-weight:800; font-size:16px; margin-bottom:15px;">–¢–û–í–ê–† –ù–ê–ô–î–ï–ù</div>
            <input type="number" id="qty-input" value="1" style="font-size:24px; text-align:center; font-weight:bold; color:var(--green);">
            <div style="display:flex; gap:10px;">
                <button class="btn-blue" onclick="confirmQty()" style="background:var(--green); color:#000;">–î–û–ë–ê–í–ò–¢–¨</button>
                <button class="btn-blue" onclick="cancelQty()" style="background:#333;">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>
    <div class="scan-ui">
        <div id="scan-msg" style="color:var(--accent); font-weight:800; font-size:14px; margin-bottom:10px;">–ù–ê–í–ï–î–ò–¢–ï –ö–ê–ú–ï–†–£</div>
        <div id="new-prod-block" style="display:none;">
            <input type="text" id="new-prod-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
            <button class="btn-blue btn-gold" onclick="saveNewProductName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
        <button class="btn-blue" style="background:#333; margin-top:10px;" onclick="closeScanner()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div class="header">
    <div class="logo">LOGIST <span>X</span></div>
    <div class="stats-main">
        <div class="s-box"><span class="s-v" id="st-total">0</span><span class="s-t">–¢–æ—á–∫–∏</span></div>
        <div class="s-box"><span class="s-v" id="st-done" style="color:var(--green)">0</span><span class="s-t">–ì–æ—Ç–æ–≤–æ</span></div>
    </div>
    <div style="display:flex; gap:10px;">
        <label class="btn-blue" style="flex:1;" for="file-in">üìÇ XLSX</label>
        <button class="btn-blue" style="flex:0.3; background:var(--red);" onclick="clearAll()">üóëÔ∏è</button>
    </div>
    <input type="file" id="file-in" hidden onchange="loadFile(this)">
    <input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞..." style="margin-top:10px;" oninput="renderList()">
</div>

<div id="list" style="padding:15px;"></div>
<div id="syncIndicator" onclick="sync()">–û–¢–ü–†–ê–í–ö–ê... <span id="qCount">0</span></div>

<div id="task-modal" class="modal">
    <div class="m-head">
        <div><div id="m-net" style="color:var(--accent); font-weight:900;"></div><div id="m-addr" style="font-size:12px; opacity:0.7;"></div></div>
        <button style="background:none; border:none; color:#fff; font-size:24px;" onclick="closeModal()">‚úï</button>
    </div>
    <div class="m-body">
        <div id="start-block">
            <div class="plan-box" id="plan-check">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã...</div>
            <button class="btn-blue btn-green" style="background:var(--green); color:#000;" onclick="startVisit()">–ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
        </div>
        <div id="work-block" style="display:none;">
            <div style="background:#1a1a1a; padding:15px; border-radius:16px; margin-bottom:15px; border: 1px solid #333;">
                <div style="font-size:12px; font-weight:800; color:var(--accent); margin-bottom:10px; text-transform:uppercase;">–°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn-blue" onclick="openScanner('shelf')" style="background:var(--accent); color:#000;">üì∑ –ü–û–õ–ö–ê</button>
                    <button class="btn-blue" onclick="openScanner('wh')" style="background:var(--blue); color:#fff;">üì∑ –°–ö–õ–ê–î</button>
                </div>
                <div id="scanned-list" style="margin-top:15px; background:#111; border-radius:10px; overflow:hidden;"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                    <div><span class="f-label">–í–°–ï–ì–û –ü–û–õ–ö–ê</span><input type="number" id="stock-shelf" value="0" readonly style="color:var(--accent); font-weight:bold;"></div>
                    <div><span class="f-label">–í–°–ï–ì–û –°–ö–õ–ê–î</span><input type="number" id="stock-wh" value="0" readonly style="color:var(--blue); font-weight:bold;"></div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–ù–ê–® –§–ï–ô–°–ò–ù–ì</span><input type="number" id="faces-mine" value="0" oninput="calcShare()"></div>
                <div><span class="f-label">–í–°–ï–ì–û –ü–û–õ–ö–ê</span><input type="number" id="faces-total" value="0" oninput="calcShare()"></div>
            </div>
            <div style="text-align:center; margin-bottom:15px;"><span class="f-label">–î–û–õ–Ø –ü–û–õ–ö–ò</span><div style="font-size:18px; font-weight:900; color:var(--accent);"><span id="share-val">0</span>%</div></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–¶–ï–ù–ê –ù–ê–®–ê</span><input type="number" id="price-our" step="0.1"></div>
                <div><span class="f-label">–¶–ï–ù–ê –ö–û–ù–ö.</span><input type="number" id="price-comp" step="0.1"></div>
            </div>
            <span class="f-label">–°–†–û–ö –ì–û–î–ù–û–°–¢–ò</span><input type="date" id="exp-date">
            <div class="photo-grid">
                <label class="cam-btn" id="l-p1">üì∏ –î–û<input type="file" hidden accept="image/*" capture="camera" onchange="procImg(this, 'pre')"></label>
                <label class="cam-btn" id="l-p2">üì∏ –ü–û–°–õ–ï<input type="file" hidden accept="image/*" capture="camera" onchange="procImg(this, 'post')"></label>
                <label class="cam-btn" id="l-p3">üì∏ –¶–ï–ù–ù–ò–ö<input type="file" hidden accept="image/*" capture="camera" onchange="procImg(this, 'price')"></label>
            </div>
            <button class="btn-blue btn-green" id="fin-btn" style="margin-top:30px; background:var(--green); color:#000;" onclick="finishVisit()">–ó–ê–í–ï–†–®–ò–¢–¨ –í–ò–ó–ò–¢</button>
        </div>
        <div id="arch-block" style="display:none; text-align:center;">
            <div style="font-size:18px; font-weight:900; color:var(--green);">–û–¢–ß–ï–¢ –û–¢–ü–†–ê–í–õ–ï–ù</div>
            <button class="btn-blue" style="margin-top:20px;" onclick="resetVisit()">üîÑ –ü–ï–†–ï–î–ï–õ–ê–¢–¨</button>
        </div>
    </div>
</div>

<div id="pdf-render">
    <div style="padding:40px; border:1px solid #000; height: 1120px; position:relative; background: #fff;">
        <div style="display:flex; justify-content:space-between; border-bottom:4px solid #000; padding-bottom:15px;">
            <div style="font-size:36px; font-weight:900;">MERCH <span style="color:#f59e0b">X</span> REPORT</div>
            <div id="pdf-date" style="font-size:16px; margin-top:15px;"></div>
        </div>
        <div style="margin-top:30px;">
            <div id="pdf-net" style="color:#f59e0b; font-weight:800; font-size:18px;"></div>
            <div id="pdf-addr" style="font-size:28px; font-weight:900;"></div>
            <div style="font-size:16px; margin-top:10px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫: <b id="pdf-worker"></b> | –í—Ä–µ–º—è: <span id="pdf-time-val"></span></div>
            <div style="background:#eee; padding:10px; margin-top:15px; font-size:12px;">GPS –°–¢–ê–¢–£–°: <b id="pdf-gps"></b></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-top:30px;">
            <div style="background:#f9f9f9; padding:20px; border-radius:20px;">
                <div style="font-size:12px; opacity:0.5;">–û–°–¢–ê–¢–ö–ò (–®–¢)</div>
                <div style="font-size:42px; font-weight:900;" id="pdf-stock">0</div>
            </div>
            <div style="background:#f9f9f9; padding:20px; border-radius:20px;">
                <div style="font-size:12px; opacity:0.5;">–î–û–õ–Ø –ü–û–õ–ö–ò</div>
                <div style="font-size:42px; font-weight:900; color:#f59e0b;"><span id="pdf-share">0</span>%</div>
            </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:30px;">
            <img id="pdf-img1" style="width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:8px;">
            <img id="pdf-img2" style="width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:8px;">
            <img id="pdf-img3" style="width:100%; aspect-ratio:3/4; object-fit:cover; border-radius:8px;">
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://logist-x-server-production.up.railway.app';
    let DATA = { shops: [], user: "", key: "" };
    let CUR = null; 
    let IMGS = { pre:null, post:null, price:null };
    let db, html5QrCode, scanTarget = 'shelf', lastCode = null, tempScanName = "";
    let MY_GPS = { lat: 0, lon: 0 };
    let SCANNED_ITEMS = [];

    function speak(txt) { if(window.speechSynthesis) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = 'ru-RU'; u.rate = 1.3; window.speechSynthesis.speak(u); } }

    window.onload = () => {
        DATA.user = localStorage.getItem('mx_user');
        DATA.key = localStorage.getItem('mx_key');
        DATA.shops = JSON.parse(localStorage.getItem('mx_shops') || "[]");
        if(!DATA.user) document.getElementById('auth-screen').style.display = 'flex';
        else { document.getElementById('auth-screen').style.display = 'none'; speak("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ"); }
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => { MY_GPS = { lat: p.coords.latitude, lon: p.coords.longitude }; renderList(); }, null, { enableHighAccuracy: true });
        }
        initDB(); renderList();
    };

    async function auth() {
        const k = document.getElementById('lic-key').value.trim().toUpperCase();
        const n = document.getElementById('work-name').value.trim();
        if(!k || !n) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
        try {
            const r = await fetch(API_URL + '/check-license', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ licenseKey: k, workerName: n }) });
            const d = await r.json();
            if(d.status === 'active') { localStorage.setItem('mx_user', n); localStorage.setItem('mx_key', k); location.reload(); }
            else alert(d.message);
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"); }
    }

    function getDist(lat1, lon1, lat2, lon2) {
        if(!lat1 || !lat2) return 999999;
        const R = 6371e3; const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
        const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dp/2)**2 + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function renderList() {
        const s = document.getElementById('srch').value.toLowerCase();
        DATA.shops.forEach(x => x.dist = getDist(MY_GPS.lat, MY_GPS.lon, x.lat, x.lon));
        DATA.shops.sort((a,b) => a.dist - b.dist);
        let doneC = 0;
        document.getElementById('list').innerHTML = DATA.shops.filter(x => x.addr.toLowerCase().includes(s)).map(x => {
            if(x.done) doneC++;
            const dB = x.dist < 100000 ? `<div class="dist-badge">${x.dist < 1000 ? Math.round(x.dist)+"–º" : (x.dist/1000).toFixed(1)+"–∫–º"}</div>` : "";
            return `<div class="card" onclick="openTask(${x.id})">${dB}<div class="dot ${x.done?'done':(x.start?'active':'')}"></div><div class="card-net">${x.net}</div><div class="card-addr">${x.addr}</div></div>`;
        }).join('');
        document.getElementById('st-total').innerText = DATA.shops.length;
        document.getElementById('st-done').innerText = doneC;
    }

    function loadFile(inp) {
        const r = new FileReader(); r.onload = e => {
            const rows = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets[0]);
            DATA.shops = rows.map((x, i) => ({ id: i, net: x['–°–µ—Ç—å']||'–ú–∞–≥–∞–∑–∏–Ω', addr: x['–ê–¥—Ä–µ—Å'], city: x['–ì–æ—Ä–æ–¥'], lat: parseFloat(x['–®–∏—Ä–æ—Ç–∞']), lon: parseFloat(x['–î–æ–ª–≥–æ—Ç–∞']), done: false }));
            localStorage.setItem('mx_shops', JSON.stringify(DATA.shops)); renderList();
        }; r.readAsArrayBuffer(inp.files[0]);
    }

    function openTask(id) {
        CUR = DATA.shops.find(x => x.id === id);
        document.getElementById('m-net').innerText = CUR.net;
        document.getElementById('m-addr').innerText = CUR.addr;
        document.getElementById('task-modal').style.display = 'flex';
        document.getElementById('start-block').style.display = CUR.done||CUR.start ? 'none' : 'block';
        document.getElementById('work-block').style.display = !CUR.done&&CUR.start ? 'block' : 'none';
        document.getElementById('arch-block').style.display = CUR.done ? 'block' : 'none';
        if(!CUR.done && !CUR.start) { checkPlan(); speak("–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ç–æ—á–∫—É " + CUR.net); }
        if(CUR.start && !CUR.done) {
            renderScannedItems();
            updateTotalFields();
        }
    }

    async function checkPlan() {
        try {
            const r = await fetch(`${API_URL}/get-planogram?key=${DATA.key}&addr=${encodeURIComponent(CUR.addr)}`);
            const d = await r.json();
            document.getElementById('plan-check').innerHTML = d.exists ? `<button class="btn-blue" onclick="window.open('${d.url}')">–°–•–ï–ú–ê –ù–ê–ô–î–ï–ù–ê (–û–¢–ö–†–´–¢–¨)</button>` : "–ü–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã –Ω–µ—Ç";
        } catch(e) { document.getElementById('plan-check').innerText = "–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–æ–≥—Ä–∞–º–º—ã"; }
    }

    function startVisit() { CUR.start = Date.now(); SCANNED_ITEMS = []; speak("–í–∏–∑–∏—Ç –Ω–∞—á–∞—Ç. –£–¥–∞—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã."); openTask(CUR.id); }

    function openScanner(t) { 
        scanTarget = t; document.getElementById('scan-overlay').style.display = 'flex'; 
        document.getElementById('new-prod-block').style.display = 'none';
        document.getElementById('scan-msg').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan, null);
        speak("–°–∫–∞–Ω–µ—Ä –≥–æ—Ç–æ–≤");
    }
    
    function closeScanner() { if(html5QrCode) html5QrCode.stop(); document.getElementById('scan-overlay').style.display = 'none'; }

    async function onScan(code) {
        if(lastCode === code) return; lastCode = code; html5QrCode.pause();
        try {
            const r = await fetch(`${API_URL}/check-barcode?code=${code}&key=${DATA.key}`);
            const d = await r.json();
            if(d.exists) { tempScanName = d.name; document.getElementById('qty-popup').style.display = 'block'; speak(d.name); }
            else { document.getElementById('scan-msg').style.display = 'none'; document.getElementById('new-prod-block').style.display = 'block'; speak("–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä"); }
        } catch(e) { speak("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); html5QrCode.resume(); lastCode = null; }
    }

    async function saveNewProductName() {
        const name = document.getElementById('new-prod-name').value;
        if(!name) return;
        tempScanName = name;
        try {
            await fetch(`${API_URL}/save-barcode`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key: DATA.key, code: lastCode, name: name }) });
            document.getElementById('new-prod-block').style.display = 'none'; 
            document.getElementById('new-prod-name').value = "";
            document.getElementById('qty-popup').style.display = 'block';
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); html5QrCode.resume(); lastCode = null; }
    }

    function confirmQty() {
        const q = parseInt(document.getElementById('qty-input').value);
        if(!q || q < 0) return;
        SCANNED_ITEMS.push({ name: tempScanName, qty: q, type: scanTarget });
        renderScannedItems(); 
        updateTotalFields();
        document.getElementById('qty-popup').style.display = 'none'; 
        document.getElementById('scan-msg').style.display = 'block';
        lastCode = null; 
        html5QrCode.resume();
        speak("–î–æ–±–∞–≤–ª–µ–Ω–æ " + q);
    }

    function cancelQty() { document.getElementById('qty-popup').style.display = 'none'; document.getElementById('scan-msg').style.display = 'block'; lastCode = null; html5QrCode.resume(); }

    function renderScannedItems() {
        const container = document.getElementById('scanned-list');
        if(SCANNED_ITEMS.length === 0) { container.innerHTML = '<div style="padding:15px; text-align:center; font-size:12px; opacity:0.5;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>'; return; }
        let html = '';
        [...SCANNED_ITEMS].reverse().forEach(item => {
            const color = item.type === 'shelf' ? 'var(--accent)' : 'var(--blue)';
            html += `<div class="scanned-item"><span style="font-size:12px;">${item.name}</span><b style="color:${color}">${item.qty} —à—Ç</b></div>`;
        });
        container.innerHTML = html;
    }

    function updateTotalFields() {
        let s = 0, w = 0;
        SCANNED_ITEMS.forEach(i => { if(i.type === 'shelf') s += i.qty; else w += i.qty; });
        document.getElementById('stock-shelf').value = s; 
        document.getElementById('stock-wh').value = w;
    }

    function calcShare() { const m = document.getElementById('faces-mine').value; const t = document.getElementById('faces-total').value; document.getElementById('share-val').innerText = t>0 ? Math.round((m/t)*100) : 0; }
    async function procImg(inp, type) { if(inp.files[0]) { IMGS[type] = await compress(inp.files[0]); inp.parentElement.classList.add('ok'); speak("–§–æ—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ"); } }
    
    function compress(file) {
        return new Promise(res => {
            const r = new FileReader(); r.onload = e => {
                const img = new Image(); img.src = e.target.result; img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    let w = img.width, h = img.height; const max = 1000;
                    if(w > h) { if(w > max) { h*=max/w; w=max; } } else { if(h > max) { w*=max/h; h=max; } }
                    c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg', 0.6));
                }
            }; r.readAsDataURL(file);
        });
    }

    async function finishVisit() {
        if(!IMGS.pre || !IMGS.post || !IMGS.price) return alert("–ù—É–∂–Ω–æ 3 —Ñ–æ—Ç–æ!");
        const btn = document.getElementById('fin-btn'); btn.disabled = true; btn.innerText = "–ì–ï–ù–ï–†–ê–¶–ò–Ø...";
        
        const now = new Date();
        const dist = getDist(MY_GPS.lat, MY_GPS.lon, CUR.lat, CUR.lon);
        const gpsStatus = dist < 300 ? "OK (–í –∑–æ–Ω–µ)" : "–í–ù–ï –ó–û–ù–´ (" + Math.round(dist) + "–º)";
        
        speak("–ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã.");

        document.getElementById('pdf-date').innerText = now.toLocaleString();
        document.getElementById('pdf-net').innerText = CUR.net;
        document.getElementById('pdf-addr').innerText = CUR.addr;
        document.getElementById('pdf-worker').innerText = DATA.user;
        document.getElementById('pdf-time-val').innerText = Math.round((now - CUR.start)/60000) + " –º–∏–Ω";
        document.getElementById('pdf-gps').innerText = gpsStatus;
        document.getElementById('pdf-stock').innerText = parseInt(document.getElementById('stock-shelf').value) + parseInt(document.getElementById('stock-wh').value);
        document.getElementById('pdf-share').innerText = document.getElementById('share-val').innerText;
        document.getElementById('pdf-img1').src = IMGS.pre; 
        document.getElementById('pdf-img2').src = IMGS.post; 
        document.getElementById('pdf-img3').src = IMGS.price;

        setTimeout(async () => {
            try {
                const canvas = await html2canvas(document.getElementById('pdf-render'));
                const report = {
                    worker: DATA.user, net: CUR.net, address: CUR.addr,
                    pdf: canvas.toDataURL('image/jpeg', 0.7),
                    lat: MY_GPS.lat, lon: MY_GPS.lon, gps_status: gpsStatus,
                    items: SCANNED_ITEMS,
                    created: Date.now()
                };
                const tx = db.transaction('reports', 'readwrite');
                tx.objectStore('reports').add(report);
                CUR.done = true; localStorage.setItem('mx_shops', JSON.stringify(DATA.shops));
                speak("–í–∏–∑–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –û—Ç—á–µ—Ç –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å.");
                closeModal(); renderList(); sync();
            } catch(e) { alert("–û—à–∏–±–∫–∞ PDF: " + e); btn.disabled = false; btn.innerText = "–ü–û–í–¢–û–†–ò–¢–¨"; }
        }, 1000);
    }

    function initDB() { 
        const r = indexedDB.open("MerchX_v2", 1); 
        r.onupgradeneeded = e => e.target.result.createObjectStore('reports', {keyPath:'id', autoIncrement:true});
        r.onsuccess = e => { db = e.target.result; updateQ(); setInterval(sync, 15000); };
    }
    function updateQ() { db.transaction('reports').objectStore('reports').count().onsuccess = e => { const c = e.target.result; document.getElementById('syncIndicator').style.display = c>0?'block':'none'; document.getElementById('qCount').innerText = c; }; }
    async function sync() {
        if(!navigator.onLine) return;
        const tx = db.transaction('reports', 'readonly');
        tx.objectStore('reports').openCursor().onsuccess = async e => {
            const cur = e.target.result;
            if(cur) {
                try {
                    const res = await fetch(API_URL + '/merch-upload', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(cur.value) });
                    if(res.ok) { db.transaction('reports', 'readwrite').objectStore('reports').delete(cur.key); updateQ(); }
                } catch(err){} cur.continue();
            }
        };
    }
    function closeModal() { document.getElementById('task-modal').style.display = 'none'; if(html5QrCode) closeScanner(); }
    function resetVisit() { if(confirm("–°–±—Ä–æ—Å–∏—Ç—å?")) { CUR.done = false; CUR.start = null; openTask(CUR.id); } }
    function clearAll() { if(confirm("–£–¥–∞–ª–∏—Ç—å –±–∞–∑—É?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>

