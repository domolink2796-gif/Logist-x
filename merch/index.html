<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOGIST_X | MERCH PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #000000; --card: #111111; --accent: #f59e0b; --green: #00ff00; --border: #222222; --text: #ffffff; --blue: #007aff; --red: #ff3b30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        
        .header { background: var(--bg); padding: 20px 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.4rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 15px; }
        .logo span { color: var(--accent); }
        
        .stats-main { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .s-box { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 12px; text-align: center; }
        .s-v { display: block; font-size: 1.1rem; font-weight: 800; }
        .s-t { font-size: 0.6rem; text-transform: uppercase; opacity: 0.5; margin-top: 4px; font-weight: 700; }
        
        .btn-blue { background: var(--blue); color: white; padding: 16px; border-radius: 14px; text-align: center; font-weight: 700; cursor: pointer; border: none; width: 100%; display: block; box-sizing: border-box; margin-bottom: 10px; text-decoration: none; }
        #srch { width: calc(100% - 30px); margin: 10px 15px; padding: 14px; background: var(--card); border: 1px solid var(--border); color: white; border-radius: 12px; box-sizing: border-box; font-size: 16px; }
        
        .card { background: var(--card); border: 1px solid var(--border); margin: 10px 15px; padding: 18px; border-radius: 16px; position: relative; }
        .card-net { font-size: 0.7rem; color: var(--accent); font-weight: 800; text-transform: uppercase; }
        .card-addr { font-size: 1rem; font-weight: 600; margin-top: 4px; }
        .dot { position: absolute; right: 18px; top: 18px; width: 10px; height: 10px; border-radius: 50%; background: #222; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .m-form { background: #000; width: 100%; max-width: 420px; padding: 25px; border-radius: 28px; border: 1px solid var(--border); box-sizing: border-box; max-height: 95vh; overflow-y: auto; }
        
        #gps-warn-box { display: none; background: rgba(255, 59, 48, 0.15); border: 1px solid var(--red); color: #ff7b72; padding: 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-align: center; margin-bottom: 15px; }

        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .cam-btn { background: #151515; border: 2px solid #333; height: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .cam-btn span { font-size: 0.65rem; font-weight: 900; margin-top: 10px; color: #666; text-transform: uppercase; }
        .cam-btn.ok { border-color: var(--green); background: rgba(0, 255, 0, 0.1); }

        .f-label { font-size: 0.65rem; text-transform: uppercase; opacity: 0.5; font-weight: 800; margin-top: 15px; display: block; }
        input { width: 100%; padding: 14px; background: #111; border: 1px solid var(--border); color: white; border-radius: 12px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
        
        .smart-scanner-box { border: 1px solid #333; border-radius: 24px; padding: 15px; margin-top: 20px; background: #080808; position: relative; }
        .scanner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .scanner-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .scan-btn { background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 14px; font-size: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .scan-btn.active-shelf { border-color: var(--blue); color: var(--blue); background: rgba(0,122,255,0.15); }
        .scan-btn.active-stock { border-color: var(--accent); color: var(--accent); background: rgba(245,158,11,0.15); }
        
        #reader { width: 100%; border-radius: 20px; overflow: hidden; margin-top: 10px; display: none; border: 2px solid #333; }
        .scanner-active #reader { display: block; }

        .item-row { background: #141414; padding: 14px; border-radius: 18px; margin-bottom: 10px; border: 1px solid #222; }
        .mini-box { background: #1a1a1a; padding: 8px; border-radius: 12px; text-align: center; }
        .mini-inp { background: transparent !important; border: none !important; text-align: center !important; font-size: 18px !important; font-weight: 900 !important; width: 100% !important; color: white; }

        #pdf-render { position: absolute; left: -9999px; width: 600px; background: #fff; color: #000; padding: 40px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div style="width:100%;">
        <center><div class="logo">LOGIST_X <span>MERCH</span></div></center>
        <input type="text" id="lic-key" placeholder="–ö–ª—é—á –õ–∏—Ü–µ–Ω–∑–∏–∏" style="text-align:center;">
        <input type="text" id="work-name" placeholder="–¢–≤–æ–µ –ò–º—è" style="text-align:center; margin-top:10px;">
        <div class="btn-blue" onclick="saveAuth()" style="margin-top:15px;">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –°–ò–°–¢–ï–ú–£</div>
    </div>
</div>

<div class="header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="logo">LOGIST_X <span>MERCH</span></div>
        <button id="syncIndicator" onclick="checkQueue()" style="background:none; border:none; color:white;">üì¶ <span id="qCount">0</span></button>
    </div>
    <div class="stats-main">
        <div class="s-box"><span class="s-v" id="st-total">0</span><span class="s-t">–¢–æ—á–µ–∫</span></div>
        <div class="s-box"><span class="s-v" id="st-done" style="color:var(--green)">0</span><span class="s-t">–í–∏–∑–∏—Ç–æ–≤</span></div>
    </div>
    <div style="display:flex; gap:10px;">
        <label class="btn-blue" for="file-in" style="flex:1;">–ó–ê–ì–†–£–ó–ò–¢–¨ –ü–õ–ê–ù</label>
        <div class="btn-blue" onclick="clearData()" style="flex:0.3; background:var(--red);">üóëÔ∏è</div>
    </div>
    <input type="file" id="file-in" class="hidden" onchange="handleFile(this)">
</div>

<input type="text" id="srch" placeholder="–ü–æ–∏—Å–∫ –º–∞–≥–∞–∑–∏–Ω–∞..." oninput="render()">
<div id="list"></div>

<div id="task-modal" class="modal">
    <div class="m-form">
        <div id="m-net" style="color:var(--accent); font-weight:800; font-size:0.7rem; text-transform:uppercase;"></div>
        
        <div id="start-block">
            <div id="gps-warn-box"></div>
            <div id="disp-addr" style="font-size: 1.2rem; font-weight: 800; margin: 15px 0;"></div>
            <button class="btn-blue" id="begin-btn" style="background:var(--green); color:black;" onclick="beginVisit()">–û–¢–ö–†–´–¢–¨ –í–ò–ó–ò–¢</button>
        </div>

        <div id="report-block" class="hidden">
            <span class="f-label">–ê–¥—Ä–µ—Å —Ç–æ—á–∫–∏</span>
            <input type="text" id="inp-addr" readonly>
            
            <div class="smart-scanner-box" id="scanner-container">
                <div id="scan-popup" style="position:absolute; top:10px; left:10px; right:10px; background:var(--green); color:#000; padding:10px; border-radius:12px; font-size:11px; font-weight:800; text-align:center; z-index:100; display:none;"></div>
                <div class="scanner-header">
                    <span style="font-size:0.6rem; font-weight:900; opacity:0.3;">MERCH_X SCANNER v3.0</span>
                    <span id="scan-mode-label" style="font-size:0.6rem; color:var(--accent); font-weight:900;"></span>
                </div>
                <div class="scanner-controls">
                    <button class="scan-btn" id="btn-shelf" onclick="toggleScanner('shelf')">üì∏ –ü–û–õ–ö–ê</button>
                    <button class="scan-btn" id="btn-stock" onclick="toggleScanner('stock')">üì∏ –°–ö–õ–ê–î</button>
                </div>
                <div id="reader"></div>
                <div id="scanned-list" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–û–±—â–∏–π –û—Å—Ç–∞—Ç–æ–∫</span><input type="number" id="i-stock" value="0"></div>
                <div><span class="f-label">–ù–∞—à –§–µ–π—Å–∏–Ω–≥</span><input type="number" id="i-faces" value="0" oninput="calcShare()"></div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><span class="f-label">–í—Å–µ–≥–æ –Ω–∞ –ø–æ–ª–∫–µ</span><input type="number" id="i-total-faces" value="0" oninput="calcShare()"></div>
                <div style="text-align:center;"><span class="f-label">–î–æ–ª—è %</span><div style="color:var(--accent); font-weight:900; font-size:1.4rem; margin-top:8px;"><span id="share-val">0</span>%</div></div>
            </div>

            <span class="f-label">–§–æ—Ç–æ–æ—Ç—á–µ—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ 3 —à—Ç)</span>
            <div class="photo-grid">
                <label class="cam-btn" id="l-p1" for="c-p1"><i>üì∏</i><span>–î–û</span></label>
                <input type="file" id="c-p1" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'pre')">
                <label class="cam-btn" id="l-p2" for="c-p2"><i>üì∏</i><span>–ü–û–°–õ–ï</span></label>
                <input type="file" id="c-p2" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'post')">
                <label class="cam-btn" id="l-p3" for="c-p3"><i>üì∏</i><span>–¶–ï–ù–ù–ò–ö</span></label>
                <input type="file" id="c-p3" accept="image/*" capture="camera" class="hidden" onchange="cam(this, 'price')">
            </div>

            <button class="btn-blue" id="finish-btn" style="background:var(--green); color:black; margin-top:20px;" onclick="saveToQueue()">–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢</button>
        </div>

        <div id="archive-block" class="hidden">
            <div id="arch-addr-title" style="font-size:1.1rem; font-weight:900; margin-bottom:10px;"></div>
            <div id="arch-items" style="margin-top:10px; border-top:1px solid #222; padding-top:10px;"></div>
            <button class="btn-blue" style="margin-top:20px; background:var(--blue);" onclick="startNewVisit()">üîÑ –ù–û–í–´–ô –í–ò–ó–ò–¢</button>
        </div>
        <button class="btn-blue" style="background:none; color:#444; margin-top:15px;" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<div id="pdf-render">
    <div style="border-bottom:3px solid #000; padding-bottom:10px;">
        <div id="p-net-addr" style="font-size:24px; font-weight:900; text-transform:uppercase;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:5px;">
            <div>–ú–µ—Ä—á–∞–Ω–¥–∞–π–∑–µ—Ä: <span id="p-worker-val" style="font-weight:bold;"></span></div>
            <div id="p-date-val"></div>
        </div>
    </div>
    <div id="p-items-summary" style="margin-top:20px; font-size:14px;"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:20px;">
        <img id="p-i1" style="width:100%; border-radius:8px;">
        <img id="p-i2" style="width:100%; border-radius:8px;">
        <img id="p-i3" style="width:100%; border-radius:8px;">
    </div>
</div>

<script>
    const API = 'https://logist-x-server-production.up.railway.app';
    let DATA = { shops: [], name: "", key: "" }, IMGS = { pre: null, post: null, price: null }, cur = null, db, syncing = false;
    let PRODUCT_CATALOG = JSON.parse(localStorage.getItem('m_catalog') || "{}"); 
    let CURRENT_ITEMS = [], html5QrCode = null, scanMode = null;

    function speak(t) { const m = new SpeechSynthesisUtterance(); m.text = t; m.lang = 'ru-RU'; window.speechSynthesis.speak(m); }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–∞–∑—ã —Ç–æ–≤–∞—Ä–æ–≤ (—á—Ç–æ–±—ã –≤—Å–µ –≤–∏–¥–µ–ª–∏ —Ç–æ–≤–∞—Ä—ã –¥—Ä—É–≥ –¥—Ä—É–≥–∞)
    async function syncCatalog() {
        if(!DATA.key) return;
        try {
            const res = await fetch(`${API}/get-catalog?key=${DATA.key}`);
            if(res.ok) {
                const cloudCatalog = await res.json();
                PRODUCT_CATALOG = {...PRODUCT_CATALOG, ...cloudCatalog};
                localStorage.setItem('m_catalog', JSON.stringify(PRODUCT_CATALOG));
            }
        } catch(e) { console.log("Catalog sync failed, using local"); }
    }

    function calcShare() {
        const mine = parseFloat(document.getElementById('i-faces').value) || 0;
        const total = parseFloat(document.getElementById('i-total-faces').value) || 0;
        document.getElementById('share-val').innerText = total > 0 ? Math.round((mine / total) * 100) : 0;
    }

    async function beginVisit() {
        cur.start = Date.now();
        localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
        // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∏–∑–∏—Ç–∞ –≤ –Ω–æ–≤—É—é —Ç–æ—á–∫—É - –æ–±–Ω—É–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
        CURRENT_ITEMS = []; 
        openModal(cur.id);
        speak("–í–∏–∑–∏—Ç –æ—Ç–∫—Ä—ã—Ç.");
    }

    function toggleScanner(mode) {
        if(scanMode === mode) { stopScanner(); } 
        else {
            if(scanMode) stopScanner();
            scanMode = mode;
            document.getElementById('scanner-container').classList.add('scanner-active');
            document.getElementById('scan-mode-label').innerText = mode === 'shelf' ? "–†–ï–ñ–ò–ú: –ü–û–õ–ö–ê (+1)" : "–†–ï–ñ–ò–ú: –°–ö–õ–ê–î (+1)";
            startScanner();
        }
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: { width: 250, height: 150 } }, (bc) => processBarcode(bc.trim())).catch(() => stopScanner());
    }

    function stopScanner() {
        scanMode = null;
        document.getElementById('scanner-container').classList.remove('scanner-active');
        if(html5QrCode) { html5QrCode.stop().then(() => html5QrCode = null).catch(() => {}); }
    }

    async function processBarcode(bc) {
        let product = PRODUCT_CATALOG[bc];
        if(product) {
            speak(product.name);
            addItem(bc, product.name);
        } else {
            stopScanner();
            speak("–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä");
            let name = prompt(`–ù–æ–≤—ã–π —à—Ç—Ä–∏—Ö-–∫–æ–¥: ${bc}\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (—Å–æ–∫, –≤–æ–¥–∞ –∏ —Ç.–¥.):`);
            if(name) {
                PRODUCT_CATALOG[bc] = { name };
                localStorage.setItem('m_catalog', JSON.stringify(PRODUCT_CATALOG));
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±—â—É—é –±–∞–∑—É, —á—Ç–æ–±—ã –∫–æ–ª–ª–µ–≥–∏ —Ç–æ–∂–µ –≤–∏–¥–µ–ª–∏
                await fetch(`${API}/save-product`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({key: DATA.key, barcode: bc, name: name}) 
                });
                addItem(bc, name);
            }
        }
    }

    function addItem(bc, name) {
        let itm = CURRENT_ITEMS.find(i => i.bc === bc);
        if(itm) {
            if(scanMode === 'shelf') itm.shelf++;
            if(scanMode === 'stock') itm.stock++;
        } else {
            CURRENT_ITEMS.unshift({ bc, name, shelf: scanMode === 'shelf' ? 1 : 0, stock: scanMode === 'stock' ? 1 : 0 });
        }
        refreshList();
    }

    function refreshList() {
        let ts = 0, tk = 0;
        document.getElementById('scanned-list').innerHTML = CURRENT_ITEMS.map(i => {
            ts += i.shelf; tk += i.stock;
            return `<div class="item-row">
                <div style="font-weight:800; margin-bottom:10px;">${i.name}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="mini-box"><span style="font-size:10px; opacity:0.5;">–ü–û–õ–ö–ê</span><input type="number" class="mini-inp" value="${i.shelf}" onchange="updateVal('${i.bc}','shelf',this.value)"></div>
                    <div class="mini-box"><span style="font-size:10px; opacity:0.5;">–°–ö–õ–ê–î</span><input type="number" class="mini-inp" value="${i.stock}" onchange="updateVal('${i.bc}','stock',this.value)"></div>
                </div>
            </div>`;
        }).join('');
        document.getElementById('i-faces').value = ts;
        document.getElementById('i-stock').value = ts + tk;
        calcShare();
    }

    function updateVal(bc, field, val) {
        let i = CURRENT_ITEMS.find(x => x.bc === bc);
        if(i) i[field] = parseInt(val) || 0;
        refreshList();
    }

    window.onload = () => {
        DATA.name = localStorage.getItem('m_name') || "";
        DATA.key = localStorage.getItem('m_key') || "";
        if(DATA.key && DATA.name) {
            document.getElementById('auth-screen').style.display = 'none';
            syncCatalog();
        }
        DATA.shops = JSON.parse(localStorage.getItem('m_shops') || "[]");
        openDB();
        render();
    };

    function openDB() {
        const req = indexedDB.open("MerchX_DB", 3);
        req.onsuccess = (e) => { db = e.target.result; updateUI(); setInterval(sync, 10000); };
        req.onupgradeneeded = (e) => { 
            const d = e.target.result;
            if(!d.objectStoreNames.contains("reports")) d.createObjectStore("reports", {keyPath:"id", autoIncrement:true});
            if(!d.objectStoreNames.contains("archive")) d.createObjectStore("archive", {keyPath:"addr"});
        };
    }

    async function saveAuth() {
        const n = document.getElementById('work-name').value.trim();
        const k = document.getElementById('lic-key').value.trim().toUpperCase();
        if(!n || !k) return;
        localStorage.setItem('m_name', n);
        localStorage.setItem('m_key', k);
        location.reload();
    }

    function render() {
        const list = document.getElementById('list'), s = document.getElementById('srch').value.toLowerCase();
        document.getElementById('st-total').innerText = DATA.shops.length;
        document.getElementById('st-done').innerText = DATA.shops.filter(x => x.done).length;
        list.innerHTML = DATA.shops.filter(x => x.addr.toLowerCase().includes(s)).map(x => `
            <div class="card" onclick="openModal(${x.id})">
                <div class="dot" style="background:${x.done ? 'var(--green)' : (x.start ? 'var(--blue)' : '#222')}"></div>
                <div class="card-net">${x.net}</div>
                <div class="card-addr">${x.addr}</div>
            </div>
        `).join('');
    }

    function openModal(id) {
        cur = DATA.shops.find(x => x.id === id);
        document.getElementById('m-net').innerText = cur.net;
        document.getElementById('task-modal').style.display = 'flex';
        
        if(cur.done) {
            document.getElementById('start-block').classList.add('hidden');
            document.getElementById('report-block').classList.add('hidden');
            document.getElementById('archive-block').classList.remove('hidden');
            loadArchive(cur.addr);
        } else if(cur.start) {
            document.getElementById('inp-addr').value = cur.addr;
            document.getElementById('start-block').classList.add('hidden');
            document.getElementById('report-block').classList.remove('hidden');
            document.getElementById('archive-block').classList.add('hidden');
            refreshList();
        } else {
            document.getElementById('disp-addr').innerText = cur.addr;
            document.getElementById('start-block').classList.remove('hidden');
            document.getElementById('report-block').classList.add('hidden');
            document.getElementById('archive-block').classList.add('hidden');
        }
    }

    async function saveToQueue() {
        if(!IMGS.pre || !IMGS.post || !IMGS.price) return alert("–ù—É–∂–Ω—ã –≤—Å–µ —Ñ–æ—Ç–æ!");
        const btn = document.getElementById('finish-btn');
        btn.innerText = "–°–û–•–†–ê–ù–ï–ù–ò–ï..."; btn.disabled = true;

        const report = {
            key: DATA.key,
            worker: DATA.name,
            net: cur.net,
            addr: cur.addr,
            items: CURRENT_ITEMS,
            faces: document.getElementById('i-faces').value,
            stock: document.getElementById('i-stock').value,
            share: document.getElementById('share-val').innerText,
            img_pre: IMGS.pre, img_post: IMGS.post, img_price: IMGS.price,
            time: new Date().toLocaleString()
        };

        const tx = db.transaction(["reports", "archive"], "readwrite");
        tx.objectStore("reports").add({...report, sending: 0});
        tx.objectStore("archive").put({addr: cur.addr, items: CURRENT_ITEMS});
        
        tx.oncomplete = () => {
            cur.done = true;
            localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
            closeModal(); render(); sync();
            btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢"; btn.disabled = false;
        };
    }

    async function sync() {
        if(syncing || !navigator.onLine) return;
        syncing = true;
        const tx = db.transaction("reports", "readwrite");
        const store = tx.objectStore("reports");
        store.openCursor().onsuccess = async (e) => {
            const cursor = e.target.result;
            if(cursor) {
                const report = cursor.value;
                if(report.sending) { cursor.continue(); return; }
                report.sending = 1; cursor.update(report);
                try {
                    const res = await fetch(`${API}/merch-upload`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(report)
                    });
                    if(res.ok) {
                        const delTx = db.transaction("reports", "readwrite");
                        delTx.objectStore("reports").delete(cursor.key);
                    }
                } catch(err) {}
                syncing = false; updateUI();
            } else syncing = false;
        };
    }

    function loadArchive(addr) {
        db.transaction("archive", "readonly").objectStore("archive").get(addr).onsuccess = (e) => {
            const d = e.target.result;
            if(d) {
                document.getElementById('arch-addr-title').innerText = addr;
                document.getElementById('arch-items').innerHTML = d.items.map(i => `<div>${i.name}: ${i.shelf} / ${i.stock}</div>`).join('');
            }
        };
    }

    function cam(input, type) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 800;
                let w = img.width, h = img.height;
                if(w > max) { h *= max/w; w = max; }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                IMGS[type] = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById(type === 'pre' ? 'l-p1' : (type === 'post' ? 'l-p2' : 'l-p3')).classList.add('ok');
            };
        };
        reader.readAsDataURL(input.files[0]);
    }

    function handleFile(inp) {
        const r = new FileReader();
        r.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            DATA.shops = rows.map((r, i) => ({
                id: i,
                net: r['–°–µ—Ç—å'] || '–ú–ê–†–ö–ï–¢',
                addr: r['–ê–¥—Ä–µ—Å'] || '?',
                done: false,
                start: null
            }));
            localStorage.setItem('m_shops', JSON.stringify(DATA.shops));
            render();
        };
        r.readAsArrayBuffer(inp.files[0]);
    }

    function closeModal() { document.getElementById('task-modal').style.display = 'none'; stopScanner(); }
    function updateUI() {
        if(!db) return;
        db.transaction("reports", "readonly").objectStore("reports").count().onsuccess = (e) => {
            document.getElementById('qCount').innerText = e.target.result;
        };
    }
    function checkQueue() { alert("–í –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É: " + document.getElementById('qCount').innerText); }
    function clearData() { if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å—ë?")) { localStorage.clear(); indexedDB.deleteDatabase("MerchX_DB"); location.reload(); } }
    function startNewVisit() { if(confirm("–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –≤–∏–∑–∏—Ç?")) { cur.done = false; cur.start = null; openModal(cur.id); } }
</script>
</body>
</html>
